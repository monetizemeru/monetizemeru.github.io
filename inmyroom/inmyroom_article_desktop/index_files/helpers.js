!function(){"use strict";var e={9302:function(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.HelpersModule=void 0;var r=o(1593),n=o(6470);t.HelpersModule={checkProductSegments:function(e,t,o){return r.checkProductSegments(o)},getDeviceUUID:function(e,t,o){return n.getDeviceUUID(t,o)}}},8089:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.helpersModuleInfo=void 0,t.helpersModuleInfo={name:"helpers",src:"helpers.js",modernSrc:"helpers.modern.js",version:"0.0.1",isSupportedByBrowser:function(){return!0},requiresSdkInitialization:function(){return!1}}},610:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CacheWithExpiry=void 0;var o=function(){function e(e,t,o){this.dateTimeMs=t,this.expiryMs=e,this.storage=o?JSON.parse(o):{},this.purge()}return e.prototype.purge=function(){var e=this.dateTimeMs();for(var t in this.storage){if(this.storage.hasOwnProperty(t))this.storage[t].expiry<e&&delete this.storage[t]}},e.prototype.get=function(e){var t=this.storage[e];if(t){if(!(t.expiry<this.dateTimeMs()))return t.value;delete this.storage[e]}},e.prototype.set=function(e,t){var o={expiry:this.dateTimeMs()+this.expiryMs,value:t};this.storage[e]=o},e.prototype.serialize=function(){return JSON.stringify(this.storage)},e}();t.CacheWithExpiry=o},1593:function(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.checkProductSegments=t.buildCompleteResponseFor=t.buildCompleteResponse=t.buildRequestDataFor=t.buildRequestData=t.toCacheKeyCollectionIdMap=t.getCacheKey=t.getSegmentationKey=t.getProductOrGroupKey=void 0;var r=o(610);t.getProductOrGroupKey=function(e){return JSON.stringify(e.ids).toLowerCase()},t.getSegmentationKey=function(e){return e.ids.externalId.toLowerCase()},t.getCacheKey=function(e,o){return e+t.getSegmentationKey(o)},t.toCacheKeyCollectionIdMap=function(e,t){for(var o={},r=0;r<e.length;r++){o[t(e[r])]=r}return o},t.buildRequestData=function(e,o,r,n,s){var u={products:[],productGroups:[],segmentations:[]},i=[],a=[],c={},p={},d={},l={};if(null!=r&&r.length>0){var g=t.buildRequestDataFor(e,r,s,(function(e){return{product:e,segmentations:[]}}));u.products=g.requestProductsOrGroups,u.segmentations=g.requestSegmentations,i=g.responseFromCache,c=t.toCacheKeyCollectionIdMap(r,t.getProductOrGroupKey),l=g.requestedSegmentations}if(null!=n&&n.length>0){var h=t.buildRequestDataFor(o,n,s,(function(e){return{productGroup:e,segmentations:[]}}));u.productGroups=h.requestProductsOrGroups;for(var m=0;m<h.requestSegmentations.length;m++){var f=h.requestSegmentations[m];l[t.getSegmentationKey(f)]||u.segmentations.push(f)}a=h.responseFromCache,p=t.toCacheKeyCollectionIdMap(n,t.getProductOrGroupKey)}return null!=s&&s.length>0&&(d=t.toCacheKeyCollectionIdMap(s,t.getSegmentationKey)),{request:u,productResponseFromCache:i,productGroupResponseFromCache:a,productOrderMap:c,productGroupOrderMap:p,segmentationOrderMap:d}},t.buildRequestDataFor=function(e,o,r,n){for(var s=[],u=[],i=[],a={},c=0;c<o.length;c++){var p=o[c],d=t.getProductOrGroupKey(p);i[c]||(i[c]=n(p));for(var l=!1,g=0;g<r.length;g++){var h=r[g],m=t.getSegmentationKey(h),f=t.getCacheKey(d,h),v=e.get(f);void 0===v?(l=!0,a[m]||(u.push(h),a[m]=!0)):v&&(i[c].segmentations[g]={ids:h.ids,segment:v})}l&&s.push(p)}return{requestProductsOrGroups:s,requestSegmentations:u,responseFromCache:i,requestedSegmentations:a}},t.buildCompleteResponse=function(e,o,r,n){var s=[];s=(s=s.concat(r.productResponseFromCache)).concat(r.productGroupResponseFromCache),null!=n.products&&n.products.length>0&&t.buildCompleteResponseFor(e,r.productResponseFromCache,n.products,r.productOrderMap,r.segmentationOrderMap),null!=n.productGroups&&n.productGroups.length>0&&t.buildCompleteResponseFor(o,r.productGroupResponseFromCache,n.productGroups,r.productGroupOrderMap,r.segmentationOrderMap);for(var u=0;u<s.length;u++){for(var i=[],a=0;a<s[u].segmentations.length;a++){var c=s[u].segmentations[a];c&&i.push(c)}s[u].segmentations=i}return{productCache:e,productGroupCache:o,response:s}},t.buildCompleteResponseFor=function(e,o,r,n,s){for(var u=0;u<r.length;u++)for(var i=r[u],a=t.getProductOrGroupKey(i),c=o[n[a]],p=0;p<i.segmentations.length;p++){var d=i.segmentations[p],l=t.getSegmentationKey(d),g=t.getCacheKey(a,d);e.set(g,d.segment||null),c.segmentations[s[l]]=d.segment?d:void 0}},t.checkProductSegments=function(e){var o,n,s,u,i,a;if((null!==(u=null!==(n=null===(o=e.products)||void 0===o?void 0:o.length)&&void 0!==n?n:0+(null===(s=e.productGroups)||void 0===s?void 0:s.length))&&void 0!==u?u:0)>50)return Promise.reject(new Error("Too many products and product groups for a single call"));if(e.segmentations.length>10)return Promise.reject(new Error("Too many segmentations for a single call"));var c="MindboxProductSegmentsCache",p="MindboxProductGroupSegmentsCache",d=new r.CacheWithExpiry(3e5,Date.now,window.localStorage.getItem(c)),l=new r.CacheWithExpiry(3e5,Date.now,window.localStorage.getItem(p)),g=t.buildRequestData(d,l,e.products,e.productGroups,e.segmentations);if(0==(null===(i=g.request.products)||void 0===i?void 0:i.length)&&0==(null===(a=g.request.productGroups)||void 0===a?void 0:a.length)){var h=t.buildCompleteResponse(d,l,g,{products:[],productGroups:[]});return new Promise((function(t,o){e.onSuccess(h.response),t()}))}return new Promise((function(o,r){window.mindbox("sync",{operation:"Tracker.CheckProductSegments",data:g.request,onError:function(t){e.onError(t),r(t)},onSuccess:function(r){var n=t.buildCompleteResponse(d,l,g,r);window.localStorage.setItem(c,n.productCache.serialize()),window.localStorage.setItem(p,n.productGroupCache.serialize()),e.onSuccess(n.response),o()}})}))}},6470:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getDeviceUUID=void 0,t.getDeviceUUID=function(e,t){return t(e),Promise.resolve()}},2:function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,o),s.exports}var r,n;r=o(9302),n=o(8089),o(2),window.mindbox[n.helpersModuleInfo.name]=r.HelpersModule}();