$(window).on('unload',hide_reply_form);$('html').click(function(event){$target=$(event.target);if(!$target.parent().is('.smile-button')&&!$target.is('.smile-button')&&!$target.is('.smile-block')&&$target.closest('.smile-block').length==0){$('.smile-block').css('display','none');$('.comments .comment .comment__text .self-post .post-content').css('z-index',10);}
if(!$target.is('.fixed-nav_profile.collapse')&&$target.closest('.fixed-nav_profile.collapse').length==0){$('.fixed-nav_profile.collapse').hide();}});$('html').keydown(function(e){if(e.keyCode==27){$('.smile-block').css('display','none');$('.comments .comment .comment__text .self-post .post-content').css('z-index',10);$('.fixed-nav_profile.collapse').hide();}});(function($){$(document).on("click",".show-more-related",function(event){event.preventDefault();$(this).siblings('.related-posts-wrap').find('.rel-hidden').removeClass('rel-hidden');$(this).remove();});})(jQuery);$(function(){commentsFormMixLowCarma();});(function($){$.fn.dateAgo=function(){return this.each(function(){var date=date_ago($(this).data('rel'),true,$(this).hasClass('nbsp'));if(date)
$(this).html(date+' '+getTranslatedString('назад'));});}
$.fn.checkEditComment=function(){return this.each(function(){var date=$(this).siblings('.dt.recalcable').data('rel');if((Math.floor(Date.now()/1000)-date)>60*60*24){$(this).remove();}});}
$('div.post').on('click','.button-edit-cancel',function(){var comment=$(this).closest('div.comment');comment.find('.button-edit-cancel').hide();comment.find('.comment-upload').remove();comment.find('.comment__info, .comment__body').show();});initEditComment();})(jQuery);function comment_spam(el,el_text)
{var $holder=$('#spam-form-holder'),$spam_form=$holder.find('form'),$submit_btn=$spam_form.find('input[type=submit]'),$self=$(el),user=$self.data("user")||$holder.data("user")||"all",hide_politic=$self.data("hide_politic")?1:0,carma=parseInt($self.data("carma")||0),is_community_moderator=(user=="community_moderator"),height={'guest':390,'admin':565,'community_moderator':565,'all':510},params=fishki.params.is_new_design?{width:1000,height:651}:{width:500,height:height[user],overlay_css:'background: rgba(0, 0, 0, 0.98)'};is_mobile=(window.innerWidth<600||$('body').hasClass('mobile_version'));var url=$self.attr('data-href')||$self.attr('href')||'/complaint/hide/';if(url)
url=(url.match(/^([^#]+)/)||[])[1];if(is_mobile){params={};}
if($spam_form.length==0)
return;var Modal=fishki.utils.Modal($holder,params);if(is_mobile){$holder.css({'left':0,'right':0,'top':0,'bottom':0});}
$spam_form.find('.radio').prop('checked',false);$submit_btn.attr('disabled','disabled');if(!$spam_form.data('inited'))
{$spam_form.data('inited',true);$spam_form.find('.radio').click(function(){var is_other=$(this).attr('id')=='reason--other';if(is_other)
{$submit_btn.removeAttr('disabled');$spam_form.find('.reason-text').removeAttr('disabled').focus();}
else
{$submit_btn.removeAttr('disabled');$spam_form.find('.reason-text').attr('disabled','disabled');}});$spam_form.submit(function(e){if(!$(this).find('.reason-text').attr('disabled')&&!$(this).find('.reason-text').val().replace(/\s+/g,'')){showMessage('Необходимо указать причину жалобы','','error');return false;}
e.preventDefault();$spam_form.find('.preloader').show();$.post(url,$(this).serialize(),function(response)
{$spam_form.find('.preloader').hide();if($self.attr('data-user-id')&&$('[name=ban_user_and_hide_comments]:checked').length){$(window).trigger('user.ban',[$self.attr('data-user-id')]);}
if(response.success)
{Modal.hide();showMessage('Жалоба успешно отправлена','');}
else
{Modal.hide();if(response.script){eval(response.script);}
if(response.message){showMessage(response.message,'','error');}
if(response.script&&!response.message||response.no_payload){showMessage('Жалоба успешно отправлена','');}}},'json');return false;});}
$spam_form.find('.spam_ban input[type=checkbox]').prop("checked",false);if(is_community_moderator){$spam_form.find('.spam_ban').hide();$spam_form.find('input[type=submit]').val('Удалить комментарий');}
else{$spam_form.find('.spam_ban').show();$spam_form.find('input[type=submit]').val('Отправить жалобу');}
if(hide_politic){$spam_form.find('.action_warning').hide();}
if(el_text&&$('#ban_user_offer_desc').length)
$('#ban_user_offer_desc').text(el_text);if($self.attr('data-post-id'))
$spam_form.find('[name=post_id]').val($self.attr('data-post-id'));if($self.attr('data-gallery-id'))
$spam_form.find('[name=gallery_id]').val($self.attr('data-gallery-id'));if($self.attr('data-comment-id'))
$spam_form.find('[name=comment_id]').val($self.attr('data-comment-id'));if(!$spam_form.find('#reason--other').prop('checked'))
$spam_form.find('[name=reason-text]').attr('disabled','disabled');$spam_form.find('[name=reason-text]').val('');$spam_form.find('[name=user]').val(user);var $labels=$spam_form.find('.ban-action[data-carma]');$labels.each(function(){if(carma>parseInt($(this).data('carma'))){$(this).hide();}else{$(this).show();}});Modal.show();return false;}
function showGeneratorForm(category,params){if(!fishki.params.my_user_id)
return false;var controller=fishki.params.is_new_design?'add':'generator';var action=!fishki.params.is_new_design&&params.is_comment?'popupFormComment':'popupForm';var is_mix=!fishki.params.is_new_design&&params.is_out_wall?'mix':'';var url=fishki.params.is_new_design?'/'+controller+'/'+action+'/'+category+'/'+is_mix:'/'+controller+'/'+category+'/'+action+'/'+is_mix;var form_real_id=params&&params.form_real_id?params.form_real_id:false;$.ajax({type:'post',data:params,url:url,dataType:'json',success:function(response){if(response.type==5){showAlert(response.message);params={form_real_id:form_real_id,from_category:category};if(fishki.params.is_new_design){$.getMultiScripts(['/js/fishki/add_drafts.js','/js/fishki/add_newdesign_popup.js','/js/fishki/libs/fabric/fabric.min.js',"https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"]).done(function(){popupInit($('.publisher__block__group.pencil_block'),params);$main_form=$('.window-block');});}}else{showMessage(response.message,'','error');}}});return false;}
function recalcCommentsDate(timer){$('.dt.recalcable').dateAgo();$('.comment-edit').checkEditComment();if(timer)setTimeout(function(){recalcCommentsDate(true);},14000);}
function update_post_comments(data)
{$postList=$('.fishki-post-list');$postListChild=$postList.children().first();if($postListChild.hasClass("list-view-items"))
$postListChild.prepend(data.html);else
$postList.prepend(data.html);if(data.script)
$('body').append(data.script);twitter_instagramParser();}
function tryParentComment($selector,$comment_id)
{var $ret=$selector.find('.idcomment-'+$comment_id);if(!$ret.length)
$ret=$selector.find('.idparentcomment-'+$comment_id);return $ret;}
function update_comments(wrapdiv,data,is_new,is_skip,mix_mode,is_answers_skip){var c_selector=$('.modal--gallery--comment').length?$('.modal--gallery--comment'):wrapdiv;if(is_new==undefined)is_new=false;if(is_skip==undefined)is_skip=false;if(mix_mode==undefined)mix_mode=false;if(is_answers_skip==undefined)is_answers_skip=false;var isAdaptiveDesign=fishki&&fishki.params&&fishki.params.isAdaptiveDesign?1:0;var havePaginator=c_selector.find('.paginator').length>0;var try_parse=false;if(!is_new&&havePaginator){is_new=true;}
if(data.list){$append_list=$('<div></div>');append_html='';for(k=0;k<data.list_keys.length;k++){i=data.list_keys[k];if(c_selector.find('.idcomment-'+i).length===0){$append_list.append(data.list[i]);}}
append_html=$append_list.html();if(fishki&&fishki.comments&&fishki.comments.onAppend){append_html=fishki.comments.onAppend(append_html);}
var c_name;if(append_html){if(mix_mode){if(data.post_id){c_name=c_selector.find('.idcomments-main-'+data.post_id+'-'+data.gallery_id);if(is_new){c_name.prepend(append_html);}else{c_name.append(append_html);}}else{showMessage(getTranslatedString('Ошибка добавления комментария'),'','error');}}else{if(is_new){if(c_selector.find('.top-comment').length)
c_selector.find('.top-comment:last').after(append_html);else
c_selector.find('.idcomments-main').prepend(append_html);}else{c_selector.find('.idcomments-main').append(append_html);}}
try_parse=true;}
var more_btn=is_skip?c_selector.find('.idcomments-main').prevAll('.comments-more'):(mix_mode?c_name.nextAll('.comments-more'):c_selector.find('.idcomments-main').nextAll('.comments-more'));if(!is_new||is_skip){if(data.more.comments&&(!is_skip||(typeof(data.more.comments.skip)!="undefined"))){var more_btn_link=more_btn.children('span, a');var more_btn_counter=more_btn_link.children('.more_c');var more_btn_tail=more_btn_link.children('.comments-more-tail');if(((data.more.comments.delta===0)||!data.more.comments.limit)||(is_skip&&!data.more.comments.skip)){more_btn.remove();}else{var tail=is_skip?(data.more.comments.skip>data.more.comments.limit?data.more.comments.limit:data.more.comments.skip):(typeof(data.more.comments.realdelta)!="undefined"?data.more.comments.realdelta:(data.more.comments.delta>data.more.comments.limit?data.more.comments.limit:data.more.comments.delta));more_btn_tail.text(is_skip?data.more.comments.skip:(typeof(data.more.comments.realdelta)!="undefined")?data.more.comments.realall:data.more.comments.delta);more_btn_counter.text(tail+' '+apply_county(tail,(is_skip?'предыдущий ':'')+'комментарий',(is_skip?'предыдущих ':'')+'комментария',(is_skip?'предыдущих ':'')+'комментариев'));var href=more_btn_link.data('href');if(href){more_btn_link.data('href',href.replace(/(\d+)(\/[ph])*$/,(is_skip?data.more.comments.skip:(data.more.comments.offset?data.more.comments.offset:data.list_keys[data.list_keys.length-1])+'$2')));}}}else{more_btn.remove();}}
hideImagePopupInModal();}
if(data.answers)
{var ins_counter=0;for(i in data.answers){var $tryAnswer,$trySel=tryParentComment(c_selector,i);if(isAdaptiveDesign){$tryAnswer=$trySel&&$trySel.length?$trySel.find('.comment-replies'):{};$trySel.addClass('has-replies');if(!$tryAnswer||!$tryAnswer.length){$trySel.after('<div class="comment-replies"></div>');$tryAnswer=$trySel.find('.comment-replies');}}else{$tryAnswer=$trySel&&$trySel.length?$trySel.next('.answers'):{};}
$append_list=$('<div></div>');append_html='';ins_counter=0;if($trySel.hasClass('remove_answer_when_loading')){$trySel.removeClass('remove_answer_when_loading');$tryAnswer.empty();}
for(k=0;k<data.answers_keys[i].length;k++){j=data.answers_keys[i][k];if(c_selector.find('.idcomment-'+j).length==0){$append_list.append(data.answers[i][j]);ins_counter++;}}
append_html=$append_list.html();if(!$tryAnswer.length){$tryAnswer=$('.idcomment-'+i);}
if(append_html){if(is_new||is_answers_skip){$tryAnswer.append(append_html);}else{$tryAnswer.prepend(append_html);}
try_parse=true;}
var what_more_btn=is_answers_skip?'last':'first';var more_btn=$tryAnswer.find('div.comments-more:'+what_more_btn+', a.comments-more:'+what_more_btn);more_btn.remove();if(data.more&&data.more[i])
{var c_html=data.more[i].delta>data.more[i].limit?c_selector.find('.idcomment-answers-more-delta-tpl').html():c_selector.find('.idcomment-answers-more-tpl').html();$tryAnswer.prepend(c_html);more_btn=$tryAnswer.find('div.comments-more:'+what_more_btn+', a.comments-more:'+what_more_btn);var more_btn_link=more_btn.children('span, a');var more_btn_counter=more_btn_link.children('.more_c');var more_btn_tail=more_btn_link.children('.comments-more-tail');if(data.more[i].delta==0||!data.more[i].limit)
more_btn.remove();else
{var tail=data.more[i].delta>data.more[i].limit?data.more[i].limit:data.more[i].all;more_btn_tail.text(data.more[i].delta);more_btn_counter.text(tail+' '+apply_county(tail,'ответ','ответа','ответов'));var href=more_btn_link.data('href');more_btn_link.data('href',href.replace('<comment>',i).replace('<last_answer>',data.answers_keys[i][0]?data.answers_keys[i][0]:9999999999));if(!data.answers_keys[i][0])more_btn.addClass('empty-answers');}}else if((data.total&&data.total[i])||ins_counter){if(is_answers_skip)
$tryAnswer.append(more_btn);else
$tryAnswer.prepend(more_btn);more_btn.removeClass('empty-answers');var more_btn_link=more_btn.children('.span_comments-more-link');var more_btn_counter=more_btn_link.children('.more_c');var more_btn_tail=more_btn_link.children('.comments-more-tail');if(data.total)
{if(data.total[i]==0){if(is_answers_skip)$tryAnswer.removeClass('skip');more_btn.remove();}
else
{var tail=data.limit?(data.total[i]>data.limit?data.limit:data.total[i]):data.total[i];if(more_btn_tail)
{var least=parseInt(more_btn_tail.text());if(!isNaN(least))
more_btn_tail.text(least-data.limit);if(least-data.limit<=0)
more_btn_tail.remove();}
more_btn_counter.text(tail+' '+apply_county(tail,'ответ','ответа','ответов'));var href=more_btn_link.data('href');var last_answer=is_answers_skip?data.answers_keys[i][data.answers_keys[i].length-1]:data.answers_keys[i][0];more_btn_link.data('href',href.replace(/(\d+)(\/[ph])*$/,last_answer+'$2').replace('<comment>',i).replace('<last_answer>',last_answer));}}
else if(ins_counter)
{var tail=parseInt(more_btn_counter.text());if(!isNaN(tail))
{tail+=ins_counter;more_btn_counter.text(tail+' '+apply_county(tail,'ответ','ответа','ответов'));}}
else more_btn.remove();}}}
if(try_parse){twitter_instagramParser();}
if(typeof(data.total_number_comments)!=undefined){c_selector.find('.count_comments').text(data.total_number_comments);c_selector.find('.count_comments_text').text(apply_county(data.total_number_comments,'комментарий','комментария','комментариев'));}
if(data.script)
$('body').append(data.script);recalcCommentsDate(false);}
function hide_reply_form(is_new){var reply_id=$('.form-save-reply-tag').removeClass('form-save-reply-tag').attr('id');var isAdaptiveDesign=fishki&&fishki.params&&fishki.params.isAdaptiveDesign?1:0;if((window.localStorage!==undefined)&&(reply_id)){if($('#'+reply_id).find('textarea').val()!=''){window.localStorage[reply_id+'_text']=$('#'+reply_id).find('textarea').val()}else{window.localStorage.removeItem(reply_id+'_text')};if($('#'+reply_id).find('.attach').find('div').length>0){window.localStorage[reply_id+'_attach']=$('#'+reply_id).find('.attach').html()}else{window.localStorage.removeItem(reply_id+'_attach')};}
if(is_new){$('.comment-reply-form').closest('.comment-upload').remove();}else{$('.comment-reply-form').parent().remove();}
if(isAdaptiveDesign){$('.comment-reply-form').next('.c_google_agreement').remove();$('.comment-reply-form').remove();}
$('.comments .comment').removeClass('answered');}
function update_comment(data)
{var c=$('.idcomment-'+data.update_comment_id);var p=c.parent().find('.comment-upload.comment-edit-form');c.after(data.comment);c.remove();if(p){p.remove();}}
function toggleSelectBoxOption(form)
{var $checked=$(form).find('.checkbox').hasClass('checked');var $form=$('.comment-form-2vk');var $checkbox=$form.find('.checkbox');var $hidden=$form.find('[type=hidden]');if($checked)
{$checkbox.removeClass('checked');$hidden.val(0);}
else
{$checkbox.addClass('checked');$hidden.val(1);}}
function loadComments(post_id,gallery_id,callback)
{var wrapidpost=$('.idpostclass_'+post_id+'_'+gallery_id);var topcomments=$('#top-comments-'+post_id+'-'+gallery_id);var wrapmodal=$('.modal--gallery--comment .comments-outer');if(wrapidpost.length||wrapmodal.length||topcomments.length)
$.getJSON('/comment/full_comments/'+post_id+'/'+gallery_id+'/',function(msg){if(wrapmodal.length)
wrapmodal.html(msg.data);else if(topcomments.length&&topcomments.find('#comments-outer').length)
topcomments.find('#comments-outer').html(msg.data);else
wrapidpost.find('#comments-outer').html(msg.data);if(typeof callback=='function')
callback(msg);if(msg.data&&msg.data.match(/<div class="fb-video"/i)){FacebookParser('fb-video');}
twitter_instagramParser();});}
function twitter_instagramParser(){try{instgrm.Embeds.process();}catch(e){}
try{twttr.widgets.load();}catch(e){}}
function switchComments(el,href)
{var _el=$(el);var wrapidpost=$('.modal--gallery--comment').length?$('.modal--gallery--comment'):(_el.closest('.wrap-comments').length?$(_el.closest('.wrap-comments')):$(_el.closest('.wrapidpost')));var current_post_id=wrapidpost.attr('data-current_post_id');var current_gal_id=wrapidpost.attr('data-current_gal_id');href=href||0;if(href==0){href=_el.data('href')||_el.attr('href');}
$.post(href,function(msg){try{msg=jQuery.parseJSON(msg);}catch(e){}
if(_el.length&&_el.parent().hasClass('comments__head-sort')){_el.parent().find('a').removeClass('current');_el.addClass('current');}
if(msg.switch_comment){if($('.modal--gallery--comment').length)
$('.modal--gallery--comment .filter-comment-switch').html(msg.switch_comment);else
wrapidpost.find('#comment-switch').html(msg.switch_comment);}
var checkElement=$('#comments-outer > .by_count_comments_hidden')[1];if((typeof checkElement==="undefined")||(typeof checkElement!=="undefined"&&checkElement.style.display!='none')){var current_URI=location.pathname;if(typeof(current_post_id)=='undefined'){var URI_current_post_id=current_URI.match(/^\/(\d)+/);if(URI_current_post_id!=null){current_post_id=(URI_current_post_id[0].match(/(\d)+$/))[0]}}
var URI_current_gal_id=current_URI.match(/(\d)+\/$/);if(URI_current_gal_id!=null){URI_current_gal_id=(URI_current_gal_id[0].match(/^(\d)+/))[0];}
if(typeof(current_gal_id)=='undefined'){current_gal_id=URI_current_gal_id;}
loadComments(current_post_id,current_gal_id);}});return false;}
function initReplyComment(){$(document).off("click",".comments .comment-reply");$(document).on("click",".comments .comment-reply",function(){if($(this).hasClass('low_reply_data')){showMessage($(this).attr('title'),'','error');return false;}else if($(this).hasClass('low_reply_carma')){showMessage('Вы не можете отвечать на комментарии из-за отрицательной кармы!','','error');return false;}
var $comment_i=$(this).closest('div.comment');var is_mix_mode=$comment_i.hasClass('mix_mode');var is_new=$comment_i.hasClass('is_new');var is_mobile=$comment_i.hasClass('is_mobile');var isAdaptiveDesign=fishki&&fishki.params&&fishki.params.isAdaptiveDesign?1:0;var reply_id=parseInt($comment_i.attr('id').replace(/comment-/,''));var gallery_id;var comm=$('#form-reply-template .comment-upload form');var target=$comment_i.data('target');if(target){$('#form-reply-template .comment-upload form').attr('action',target);}
if(is_mix_mode){reply_id=0;}
hide_reply_form(is_new);if(!isNaN(reply_id)){if(isAdaptiveDesign){$comment_i.find('.comment__reactions').first().after($('#form-reply-template').html());}else{$comment_i.addClass('answered').append($('#form-reply-template').html());}
$comment_i.find('form').addClass('comment-reply-form').attr('id','form_reply_comment'+reply_id).find('input[name=reply]').val(reply_id).end().find('input[name=reply_to_user]').val($(this).data('rel')).end().find('textarea').val('').end().find('textarea').attr('id','comment-reply-form-id').end().find('[id=post_to_vk_answer_template]').attr('id','post_to_vk_answer').prop('checked',$('#post_to_vk').prop('checked')).end().find('[for=post_to_vk_answer_template]').attr('for','post_to_vk_answer');$comment_i.find('form.comments-form').jamCommentForm({mobile:is_mobile,is_mix_mode:is_mix_mode,is_answer:true,is_new:is_new});if(typeof fishki.user_autocomplete!="undefined"){fishki.user_autocomplete.init($comment_i.find('textarea'));}
if(typeof autosize!="undefined"){autosize($('#comment-reply-form-id'));}
if(fishki.params.my_user_id){$comment_i.find('textarea.cmment-textarea').focus();}
return false;}});openLastEditedComment();}
function initEditComment(){$(document).on("click",".comments a.comment-edit",function(){var $comment_i=$(this).closest('div.comment');var is_mix_mode=$comment_i.hasClass('mix_mode');var is_new=$comment_i.hasClass('is_new');var is_mobile=$comment_i.hasClass('is_mobile');var comment_id=parseInt($comment_i.attr('id').replace(/comment-/,''));$comment_i.append('<div class="preloader"></div>')
$.ajax({type:'post',url:'/comment/edit_comment/'+comment_id+'/',dataType:'json',success:function(response){$comment_i.find('.preloader').remove();if(typeof(response.comment)!=="undefined")
{var comment=response.comment;if(typeof(comment.links.links_ext)=="undefined")
comment.links.links_ext=[];var comm=$('#form-reply-template .comment-upload form');var edit_text=comment.body_original;window.prevent_hash_edit=[];for(var i=0;i<comment.links.links_ext.length;i++){var link=comment.links.links_ext[i];if(link.hash&&prevent_hash_edit[link.hash]==undefined){prevent_hash_edit[link.hash]={true_link:link.true_link,link:link.link,id:"#image-preview-"+link.id};}}
$comment_i.addClass('edited').find('.comment__info').hide().end().find('.comment__body ').hide().end();$comment_i.append($('#form-reply-template').html());$comment_i.find('form').addClass('comment-edit-form').attr('action','/comment/edit/'+comment.id).attr('id','form_edit_comment'+comment.id).find('input[name=edit]').val(comment.id).end().find('textarea.comment-textarea').val(edit_text).end().find('.comments-form__checkboxes').remove();$comment_i.find('form.comments-form').jamCommentForm({mobile:is_mobile,is_mix_mode:is_mix_mode,is_answer:true,is_new:is_new,is_edit:true});if(typeof autosize!="undefined"){autosize($('#comment-reply-form-id'));autosize($comment_i.find('textarea.comment-textarea'));}
if(typeof fishki.user_autocomplete!="undefined"){fishki.user_autocomplete.init($comment_i.find('textarea'));var notify_users=comment.notify_users;if(notify_users)
{var notifyadd=$comment_i.find('.notify_add');$.each(notify_users,function(ind,val){notifyadd.find('.notify_add-users').append('<a class="comment_notify-a">'+val['name']+'<span class="notify_add-cancel">x</span><input type="hidden" name="notify_users[]" value="'+val['id']+'">'+'</a>');});}
$('.notify_add .notify_add-cancel').bind('click',function(){var tmp=$(this).closest('.notify_add');var this_a=$(this).parent();var text_area=this_a.parent().parent().parent().find('textarea');var text_area_val=text_area.val();text_area.val(text_area_val.replace('@'+this_a.find('input').val(),''));var count_notify=tmp.find('.notify_add-users a').length-1;if(count_notify>1)
tmp.find('.notify_add-text').text('Упомянуты: ');else if(count_notify==1)
tmp.find('.notify_add-text').text('Упомянут: ');else
tmp.find('.notify_add-text').text('');this_a.remove();});}
$comment_i.find('.button-edit-cancel').show();$comment_i.find('textarea.comment-textarea').focus();var comment_area=$comment_i.find('textarea.comment-textarea').get(0);$comment_i.find('textarea.comment-textarea').keyup(function(event){for(var index in prevent_hash_edit){if(prevent_hash_edit.hasOwnProperty(index)){if(comment_area.value.indexOf(prevent_hash_edit[index].true_link)>=0){$(prevent_hash_edit[index].id).show();}else{$(prevent_hash_edit[index].id).hide();}}}});for(var i=0;i<comment.links.links_ext.length;i++){var link=comment.links.links_ext[i];$block=$comment_i.find('.attaches');if($block.find('.reply-attached.loading').length>0)
{$($block.find('.reply-attached.loading')[0]).remove();}
var preview_size_x=200;var preview_size_y=200;var input_name='attach';if(link.link){var value=link.link;if(typeof(link.small)=="undefined"||link.small==""){link.small=link.tn;}
if((link.sw==""&&link.sh=="")||(link.sw=="0"&&link.sh=="0")){link.sw=link.pw;link.sh=link.ph;}
if(link.type=='video'){input_name='attach_video';preview_size_x=200;}
var hash_src=typeof(link.hash)!='undefined'?link.hash:'';if(link.type=='embeded'){input_name='attach_embed';preview_size_x=615;var block='<div class="image-preview reply-attached type_'+input_name+'" id="image-preview-'+link.id+'" style="width: '+preview_size_x+'px; overflow: hidden;">'+'<input type="hidden" class="hash_src" value="'+hash_src+'"/>'+'<input type="hidden" name="'+input_name+'[]" value="'+value+'"/>'+link.embed+'<a href="javascript: void 0" class="close" onclick="removeImageFromEdit(this);">&times;</a>'+'</div>';}else{var size=fishki.utils.resizeCenter(link.sw,link.sh,preview_size_x,preview_size_y);var block='<div class="image-preview reply-attached type_'+input_name+'" id="image-preview-'+link.id+'" style="width: '+preview_size_x+'px; height: '+preview_size_y+'px; overflow: hidden;">';if(input_name=='attach_video')
block+='<div class="video_holder">';block+='<input type="hidden" name="'+input_name+'[]" value="'+value+'"/>'+'<input type="hidden" class="hash_src" name="hash_src['+link.id+']" value="'+hash_src+'"/>'+'<img src="'+link.small+'" width="'+size.width+'" height="'+size.height+'" style="margin-left: '+size.marginLeft+'px; margin-top: '+size.marginTop+'px" />'+'<a href="javascript: void 0" class="close" onclick="removeImageFromEdit(this);">&times;</a>';if(input_name=='attach_video')
block+='</div>';block+='</div>';}
$block.append($(block));if(link.type=='embeded'){if(link.embeded_type=='twitter'){try{twttr.widgets.load();}catch(e){}}
if(link.embeded_type=='instagram'){try{instgrm.Embeds.process();}catch(e){}}}}}
return false;}else{showMessage(response.message,'','error');}},error:function(){$comment_i.find('.preloader').remove();}});});}
function stripSmiles(text)
{return text.replace(/:[0-9a-z_\-]{1,15}:/g,'');}
function showhiddencomment(el)
{var now=$(el).parent();$(now).parent().toggleClass('back-comment-hidden');$(now).hide();$(now).next().show();$(now).next().next().show();return false;}
function extraCommentToggle(el)
{var $self=$(el).toggleClass('minus');$self.parents('div.meta').find('.extra-comment-buttons').toggleClass('show');}
function fitVideoTextarea(element){if(element.length==0){return false;}
if(element.parent().find('input').length==0){inp=element.parent().find('textarea');}else{inp=element.parent().find('input');}
w=inp.width();if(w<150)r=5;if(150<=w&&w<=182)r=4;if(183<=w&&w<=280)r=3;if(280<w)r=2;inp.attr('rows',r);if(fishki.params.is_new_design)top_shift=(inp.parent().outerHeight()-35)/2-1;else top_shift=(inp.parent().outerHeight()-50)/2+4;element.parent().find('.save.ok').css('top',top_shift+'px');}
function toggleCheck(id){$('#'+id).prop('checked',!($('#'+id).is(':checked')));}
function removeImageFromEdit($this)
{var form=$($this).closest('.comments-form');if(form.hasClass('comment-edit-form')){var hash=$($this).closest('.image-preview').find('input.hash_src').val();if(prevent_hash_edit[hash]!=undefined){var textarea=form.find('textarea.comment-textarea');var text=textarea.val();text=text.replace(new RegExp(prevent_hash_edit[hash].true_link,"m"),'');textarea.val(text);}}
$($this).parents('.image-preview').remove();}
function setAsAds(id,th){id=parseInt(id);if(id)
$.post('/comment/setasad/'+id+'/',function(response){if(response.ok){if(response.ok==1){$(th).css('color','green');showMessage(getTranslatedString('Комментарий установлен для просмотра на главной!'));}else{$(th).css('color','');showMessage(getTranslatedString('Комментарий снят с просмотра на главной!'));}}else{showMessage(getTranslatedString('Ошибка!'),'','error');}},'json');}
function updateCommentForms()
{if($('form.comments-form').length&&fishki.params.is_new_design)
{var tmp=$('form.comments-form').attr('data-id');tmp=tmp.split('_');var post=tmp[0];var gallery=tmp[1];$.ajax({type:'get',url:'/comment/get_formComment/'+post+'/'+gallery,dataType:'html',success:function(response){$('form.comments-form').find('.not-logged').remove();var tmp=$(response).find('form').html();var bans='';if($(response).find('.not-logged').length)
{$(response).find('.not-logged').each(function(){bans+=$(this)[0].outerHTML;});$('.comments-form').each(function(){$(this).append(bans);});}
commentsFormMixLowCarma();}});}}
if(localStorage){function storageChangedUser(storageEvent){if(storageEvent.key=='user_id'&&storageEvent.oldValue!=storageEvent.newValue){updateCommentForms();}}
window.addEventListener('storage',storageChangedUser,false);$(function(){if(!localStorage.user_id){$.ajax({type:'get',url:'/user/getThisUserId/',success:function(response){if(!isNaN(response)){localStorage.user_id=response;}}});}
$('a[href^="/user/logout"]').click(function(){window.removeEventListener('storage',storageChangedUser,false);localStorage.user_id=0;});});}
function commentsFormMixLowCarma(){if($('.mixLowCarma').length){$('.mixLowCarma').each(function(){var actdate=parseInt($(this).attr('data-time'));var diff=Math.floor(Date.now()/1000)-actdate;if(diff>60*10)
$(this).parent().parent().parent().remove();else{var minutes=10-Math.floor(diff/60);$(this).text(minutes+' '+apply_county(minutes,'минуту','минуты','минут'));}});setTimeout(function(){commentsFormMixLowCarma();},14000);}}
function toggleCommentOnlineStatus(thisId){var id='is_show_online';var status=$('#'+id).is(':checked')?0:1;fishki.profile.setSettings('isShowOnline',status);if(thisId!==id)
$('#'+id).prop('checked',(status?true:false));}
function toggleComment(id){var comment=$('#comment-'+id);if(comment.find('.comment-delete').is(":visible")){comment.find('.comment-delete').hide();comment.find('.comment__info').show();comment.find('.comment__body').show();}else{comment.find('.comment__info').hide();comment.find('.comment__body').hide();comment.find('.comment-delete').show();comment.find('.btn-comment-cancel').css("width","auto");comment.find('.btn-comment-remove').css("width","auto");}}
function mixShowErotica(checkbox){var $checkbox=$(checkbox);var isChecked=$checkbox.is(':checked');var href='/user/toggle_mix_show_erotica/'+(isChecked?1:0);$.post(href,function(data){data=JSON.parse(data);if(data&&data.ok){$.post(window.location.pathname,function(pageData){var $html=$(pageData);var $posts=$html.find('.list-view-items');if($posts.length){$('.list-view-items').replaceWith($posts);fishki.scroll.scrollLazyLoadInit();}});}
else
showMessage('Не удалось обновить статус показа эротики в ленте солянки','','error');});}
function openLastEditedComment(){if(window.localStorage!==undefined){var lastComment=window.localStorage['lastEditedComment']?window.localStorage['lastEditedComment']:'';var commentData=lastComment.split('_');if(fishki.params.my_user_id&&commentData.length==4){var postId=parseInt(commentData[0]),gallId=parseInt(commentData[1]),commId=parseInt(commentData[2]),userId=parseInt(commentData[3]);if(fishki.params.my_user_id==userId){if(commId)
$('#comment-'+commId+' a.comment-reply').click();else
$('#post-'+postId+' .comment.mix_mode a.comment-reply').click();}}}}
function manageUAData(){if(!manageUAData.working){manageUAData.working=true;var $usersAppealUA=$('.users_appeal_ua:not(.managed)');if($usersAppealUA.length){$usersAppealUA.addClass('managed').on('mouseover',function(e){var $this=$(this);$this.addClass('mouseover');var $dialog=$this.find('.users_appeal-dialog');if($dialog.length){var winW=window.innerWidth||$(window).width();var dlgLeft=$dialog.offset().left;var dlgWidth=$dialog.width();var dlgMinW=200;var toRight=winW-(dlgLeft+dlgWidth);if(toRight<0){var diff=dlgWidth+toRight-25;if(diff>dlgMinW){$dialog.width(diff)}else{$dialog.css({'width':dlgMinW,'top':11,'left':$dialog.position().left-(dlgMinW-diff)});}}}}).on('mouseout',function(e){var $relT=$(e.relatedTarget);if(!$relT.closest('.users_appeal_ua').length){var $this=$(this);var $dialog=$this.find('.users_appeal-dialog');if($dialog.length){$this.removeClass('mouseover');}}});}
manageUAData.working=false;}};(function($){$.fn.caret=function(pos){var target=this[0];var isContentEditable=target&&target.contentEditable==='true';if(arguments.length==0){if(target){if(window.getSelection){if(isContentEditable){target.focus();var range1=window.getSelection().getRangeAt(0),range2=range1.cloneRange();range2.selectNodeContents(target);range2.setEnd(range1.endContainer,range1.endOffset);return range2.toString().length;}
return target.selectionStart;}
if(document.selection){target.focus();if(isContentEditable){var range1=document.selection.createRange(),range2=document.body.createTextRange();range2.moveToElementText(target);range2.setEndPoint('EndToEnd',range1);return range2.text.length;}
var pos=0,range=target.createTextRange(),range2=document.selection.createRange().duplicate(),bookmark=range2.getBookmark();range.moveToBookmark(bookmark);while(range.moveStart('character',-1)!==0)pos++;return pos;}
if(target.selectionStart)
return target.selectionStart;}
return;}
if(target){if(pos==-1)
pos=this[isContentEditable?'text':'val']().length;if(window.getSelection){if(isContentEditable){target.focus();window.getSelection().collapse(target.firstChild,pos);}
else
target.setSelectionRange(pos,pos);}
else if(document.body.createTextRange){if(isContentEditable){var range=document.body.createTextRange();range.moveToElementText(target);range.moveStart('character',pos);range.collapse(true);range.select();}else{var range=target.createTextRange();range.move('character',pos);range.select();}}
if(!isContentEditable)
target.focus();}
return this;}})(jQuery);;(function(){var properties=['direction','boxSizing','width','height','overflowX','overflowY','borderTopWidth','borderRightWidth','borderBottomWidth','borderLeftWidth','borderStyle','paddingTop','paddingRight','paddingBottom','paddingLeft','fontStyle','fontVariant','fontWeight','fontStretch','fontSize','fontSizeAdjust','lineHeight','fontFamily','textAlign','textTransform','textIndent','textDecoration','letterSpacing','wordSpacing','tabSize','MozTabSize'];var isBrowser=(typeof window!=='undefined');var isFirefox=(isBrowser&&window.mozInnerScreenX!=null);function getCaretCoordinates(element,position,options){if(!isBrowser){throw new Error('textarea-caret-position#getCaretCoordinates should only be called in a browser');}
var debug=options&&options.debug||false;if(debug){var el=document.querySelector('#input-textarea-caret-position-mirror-div');if(el){el.parentNode.removeChild(el);}}
var div=document.createElement('div');div.id='input-textarea-caret-position-mirror-div';document.body.appendChild(div);var style=div.style;var computed=window.getComputedStyle?getComputedStyle(element):element.currentStyle;style.whiteSpace='pre-wrap';if(element.nodeName!=='INPUT')
style.wordWrap='break-word';style.position='absolute';if(!debug)
style.visibility='hidden';properties.forEach(function(prop){style[prop]=computed[prop];});if(isFirefox){if(element.scrollHeight>parseInt(computed.height))
style.overflowY='scroll';}else{style.overflow='hidden';}
div.textContent=element.value.substring(0,position);if(element.nodeName==='INPUT')
div.textContent=div.textContent.replace(/\s/g,'\u00a0');var span=document.createElement('span');span.textContent=element.value.substring(position)||'.';div.appendChild(span);var coordinates={top:span.offsetTop+parseInt(computed['borderTopWidth']),left:span.offsetLeft+parseInt(computed['borderLeftWidth'])};if(debug){span.style.backgroundColor='#aaa';}else{document.body.removeChild(div);}
return coordinates;}
if(typeof module!='undefined'&&typeof module.exports!='undefined'){module.exports=getCaretCoordinates;}else if(isBrowser){window.getCaretCoordinates=getCaretCoordinates;}}());;var fishki;if(!fishki)fishki={};(function(){var user_autocomplete={};user_autocomplete.lasttextarea=0;user_autocomplete.SelectedItem=-1;user_autocomplete.search='';user_autocomplete.selectVal=function(paragraph){var textbox=user_autocomplete.get_textarea();var pos=$(textbox).caret();var start=textbox.value.substr(0,pos);var end=textbox.value.substr(pos);var atPos=start.lastIndexOf('@');var replaceId=$(paragraph).attr('data-user')==='0'?"Модератор Fishki.net":$(paragraph).attr('data-user');textbox.value=start.substr(0,atPos)+'@'+replaceId+end;$(textbox).caret(textbox.value.length-end.length);var formarea=$(textbox).parent().parent();formarea.find('.notify_add-users').append('<a class="comment_notify-a">'+$(paragraph).attr('data-username')+'<span class="notify_add-cancel">x</span>'+'<input type="hidden" name="notify_users[]" value="'+$(paragraph).attr('data-user')+'"></a>');var count_notify=formarea.find('.notify_add-users a').length;if(count_notify>1)
formarea.find('.notify_add-text').text('Упомянуты: ');else
formarea.find('.notify_add-text').text('Упомянут: ');formarea.find('.notify_add-users .notify_add-cancel').unbind('click');formarea.find('.notify_add-users .notify_add-cancel').bind('click',function(){var tmp=$(this).closest('.notify_add');var this_a=$(this).parent();var text_area=this_a.parent().parent().parent().find('textarea');if(!text_area.length){text_area=this_a.parent().parent().parent().parent().find('textarea');}
var text_area_val=text_area.val();text_area.val(text_area_val.replace('@'+this_a.find('input').val(),''));var count_notify=tmp.find('.notify_add-users a').length-1;if(count_notify>1)
tmp.find('.notify_add-text').text('Упомянуты: ');else if(count_notify==1)
tmp.find('.notify_add-text').text('Упомянут: ');else
tmp.find('.notify_add-text').text('');this_a.remove();});user_autocomplete.hideSuggestion();}
user_autocomplete.hideSuggestion=function(){document.getElementById('ua_suggestions').style.display='none';user_autocomplete.SelectedItem=-1;}
user_autocomplete.getSearchStr=function(textbox){var pos=$(textbox).caret();var search='';var isValid=false;for(var i=pos-1;i>=0;i--){var char=textbox.value.charAt(i).toLowerCase();if(char!='@'){search=char+search;}
else{if(char=='@'){if(i==0||textbox.value.charAt(i-1).match(/\s/)){isValid=true;}}
break;}}
if(search=='модератор fishki.net'){return'';}
if(!isValid)
search='';return search;};user_autocomplete.search=function(){var textbox=user_autocomplete.get_textarea();var search=user_autocomplete.getSearchStr(textbox);if(search.length>1&&search.length<=32){var params={};params.q=search;params.exclude_users=[];var exclude_inputs=$(textbox).parent().parent().find('.notify_add input[name="notify_users[]"]');exclude_inputs.each(function(){params.exclude_users.push($(this).val());});params.notify=1;$.ajax({type:'post',data:params,url:'/findusers/',dataType:'json',success:function(response){var tmpsearch=user_autocomplete.getSearchStr(textbox);if(search==tmpsearch)
{var map=$.map(response.result,function(item){return{id:item.id,name:item.name,value:item.id,html:item.html,carma:item.carma}});map.sort(function(a,b){return parseInt(b.carma)-parseInt(a.carma);});user_autocomplete.showSuggestion(map);}
else
user_autocomplete.hideSuggestion();},error:function(){user_autocomplete.hideSuggestion();}});}
else{user_autocomplete.hideSuggestion();}}
user_autocomplete.showSuggestion=function(searchResults){if(searchResults.length==0){user_autocomplete.hideSuggestion();return;}
var text='';var i=0;$.each(searchResults,function(index,value){text+='<div onmousedown="fishki.user_autocomplete.selectVal(this);return false;" onmouseover="fishki.user_autocomplete.selectItem('+i+');" id="ua_div'+i+'" data-user="'+searchResults[index]['id']+'" data-username="'+searchResults[index]['name']+'"  class="item_auto_subscibe">'+searchResults[index]['html']+'</div>';i++;});var textbox=user_autocomplete.get_textarea();var pos=$(textbox).caret();var textboxPosition=$(textbox).offset();var caretPosition=getCaretCoordinates(textbox,pos);var elem=document.getElementById('ua_suggestions');elem.style.top=(caretPosition.top+textboxPosition.top-$(textbox).scrollTop()+20)+'px';elem.style.left=(caretPosition.left+textboxPosition.left+10)+'px';elem.innerHTML=text;elem.style.display='inline-block';user_autocomplete.selectItem(0);$('#ua_suggestions').scrollTop(0);}
user_autocomplete.isShowing=function(){return(document.getElementById('ua_suggestions').style.display=='inline-block');}
user_autocomplete.keyup=function(evt){user_autocomplete.disableKeys(evt);var code=evt.keyCode?evt.keyCode:evt.which;if(code==27)
user_autocomplete.hideSuggestion();else if(!user_autocomplete.isShowing()||(code!=38&&code!=40&&(code!=13||user_autocomplete.SelectedItem==-1)))
user_autocomplete.search();}
user_autocomplete.keydown=function(evt){if(!user_autocomplete.isShowing())return;user_autocomplete.disableKeys(evt);var newSelection=user_autocomplete.SelectedItem;var code=evt.keyCode?evt.keyCode:evt.which;switch(code){case 38:newSelection--;break;case 40:newSelection++;break;case 13:$('#ua_div'+user_autocomplete.SelectedItem).mousedown();return;default:return;}
var pList=$('#ua_suggestions > div');if(newSelection<0){newSelection=pList.length-1;}
else if(newSelection>=pList.length){newSelection=0;}
if(newSelection>=0){var tmp=0;pList.each(function(index){if(index<newSelection)
tmp+=parseInt($(this).height());});$('#ua_suggestions').scrollTop(tmp);}
user_autocomplete.selectItem(newSelection);}
user_autocomplete.keypress=function(evt){user_autocomplete.disableKeys(evt);}
user_autocomplete.disableKeys=function(evt){if(!user_autocomplete.isShowing())return;var code=evt.keyCode?evt.keyCode:evt.which;switch(code){case 13:if(user_autocomplete.SelectedItem==-1)return;case 27:case 38:case 40:evt.preventDefault();}}
user_autocomplete.selectItem=function(selectedItem){if($('#ua_div'+user_autocomplete.SelectedItem).length){$('#ua_div'+user_autocomplete.SelectedItem).removeClass('ua-hover');}
if($('#ua_div'+selectedItem).length){$('#ua_div'+selectedItem).addClass('ua-hover');user_autocomplete.SelectedItem=selectedItem;}
else{$('#ua_div'+0).addClass('ua-hover');user_autocomplete.SelectedItem=0;$('#ua_suggestions').scrollTop(0);}}
user_autocomplete.get_textarea=function(selectedItem){var ret=$(document.activeElement);if(ret.is('textarea'))
lasttextarea=ret;else
ret=typeof(lasttextarea)!=='undefined'?lasttextarea:null;return ret?ret.get(0):null;}
user_autocomplete.init=function(textareas,by_selector){by_selector=by_selector||false;var $div=$('<div />').appendTo('body').attr('id','ua_suggestions');if(by_selector){$(document).on('keyup',textareas,user_autocomplete.keyup);$(document).on('keydown',textareas,user_autocomplete.keydown);$(document).on('keypress',textareas,user_autocomplete.keypress);$(document).on('click',textareas,user_autocomplete.search);$(document).on('blur',textareas,user_autocomplete.search);}else{textareas.keyup(user_autocomplete.keyup);textareas.keydown(user_autocomplete.keydown);textareas.keypress(user_autocomplete.keypress);textareas.click(user_autocomplete.search);textareas.blur(user_autocomplete.search);}}
fishki.user_autocomplete=user_autocomplete;})();;
/*!
 * jQuery Form Plugin
 * version: 3.46.0-2013.11.21
 * Requires jQuery v1.5 or later
 * Copyright (c) 2013 M. Alsup
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Project repository: https://github.com/malsup/form
 * Dual licensed under the MIT and GPL licenses.
 * https://github.com/malsup/form#copyright-and-license
 */
(function(factory){if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else{factory((typeof(jQuery)!='undefined')?jQuery:window.Zepto);}}
(function($){"use strict";var feature={};feature.fileapi=$("<input type='file'/>").get(0).files!==undefined;feature.formdata=window.FormData!==undefined;var hasProp=!!$.fn.prop;$.fn.attr2=function(){if(!hasProp)
return this.attr.apply(this,arguments);var val=this.prop.apply(this,arguments);if((val&&val.jquery)||typeof val==='string')
return val;return this.attr.apply(this,arguments);};$.fn.ajaxSubmit=function(options){if(!this.length){log('ajaxSubmit: skipping submit process - no element selected');return this;}
var method,action,url,$form=this;if(typeof options=='function'){options={success:options};}
else if(options===undefined){options={};}
method=options.type||this.attr2('method');action=options.url||this.attr2('action');url=(typeof action==='string')?$.trim(action):'';url=url||window.location.href||'';if(url){url=(url.match(/^([^#]+)/)||[])[1];}
options=$.extend(true,{url:url,success:$.ajaxSettings.success,type:method||$.ajaxSettings.type,iframeSrc:/^https/i.test(window.location.href||'')?'javascript:false':'about:blank'},options);var veto={};this.trigger('form-pre-serialize',[this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');return this;}
if(options.beforeSerialize&&options.beforeSerialize(this,options)===false){log('ajaxSubmit: submit aborted via beforeSerialize callback');return this;}
var traditional=options.traditional;if(traditional===undefined){traditional=$.ajaxSettings.traditional;}
var elements=[];var qx,a=this.formToArray(options.semantic,elements);if(options.data){options.extraData=options.data;qx=$.param(options.data,traditional);}
if(options.beforeSubmit&&options.beforeSubmit(a,this,options)===false){log('ajaxSubmit: submit aborted via beforeSubmit callback');return this;}
this.trigger('form-submit-validate',[a,this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-submit-validate trigger');return this;}
var q=$.param(a,traditional);if(qx){q=(q?(q+'&'+qx):qx);}
if(options.type.toUpperCase()=='GET'){options.url+=(options.url.indexOf('?')>=0?'&':'?')+q;options.data=null;}
else{options.data=q;}
var callbacks=[];if(options.resetForm){callbacks.push(function(){$form.resetForm();});}
if(options.clearForm){callbacks.push(function(){$form.clearForm(options.includeHidden);});}
if(!options.dataType&&options.target){var oldSuccess=options.success||function(){};callbacks.push(function(data){var fn=options.replaceTarget?'replaceWith':'html';$(options.target)[fn](data).each(oldSuccess,arguments);});}
else if(options.success){callbacks.push(options.success);}
options.success=function(data,status,xhr){var context=options.context||this;for(var i=0,max=callbacks.length;i<max;i++){callbacks[i].apply(context,[data,status,xhr||$form,$form]);}};if(options.error){var oldError=options.error;options.error=function(xhr,status,error){var context=options.context||this;oldError.apply(context,[xhr,status,error,$form]);};}
if(options.complete){var oldComplete=options.complete;options.complete=function(xhr,status){var context=options.context||this;oldComplete.apply(context,[xhr,status,$form]);};}
var fileInputs=$('input[type=file]:enabled',this).filter(function(){return $(this).val()!=='';});var hasFileInputs=fileInputs.length>0;var mp='multipart/form-data';var multipart=($form.attr('enctype')==mp||$form.attr('encoding')==mp);var fileAPI=feature.fileapi&&feature.formdata;log("fileAPI :"+fileAPI);var shouldUseFrame=(hasFileInputs||multipart)&&!fileAPI;var jqxhr;if(options.iframe!==false&&(options.iframe||shouldUseFrame)){if(options.closeKeepAlive){$.get(options.closeKeepAlive,function(){jqxhr=fileUploadIframe(a);});}
else{jqxhr=fileUploadIframe(a);}}
else if((hasFileInputs||multipart)&&fileAPI){jqxhr=fileUploadXhr(a);}
else{jqxhr=$.ajax(options);}
$form.removeData('jqxhr').data('jqxhr',jqxhr);for(var k=0;k<elements.length;k++)
elements[k]=null;this.trigger('form-submit-notify',[this,options]);return this;function deepSerialize(extraData){var serialized=$.param(extraData,options.traditional).split('&');var len=serialized.length;var result=[];var i,part;for(i=0;i<len;i++){serialized[i]=serialized[i].replace(/\+/g,' ');part=serialized[i].split('=');result.push([decodeURIComponent(part[0]),decodeURIComponent(part[1])]);}
return result;}
function fileUploadXhr(a){var formdata=new FormData();for(var i=0;i<a.length;i++){formdata.append(a[i].name,a[i].value);}
if(options.extraData){var serializedData=deepSerialize(options.extraData);for(i=0;i<serializedData.length;i++)
if(serializedData[i])
formdata.append(serializedData[i][0],serializedData[i][1]);}
options.data=null;var s=$.extend(true,{},$.ajaxSettings,options,{contentType:false,processData:false,cache:false,type:method||'POST'});if(options.uploadProgress){s.xhr=function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(event){var percent=0;var position=event.loaded||event.position;var total=event.total;if(event.lengthComputable){percent=Math.ceil(position/total*100);}
options.uploadProgress(event,position,total,percent);},false);}
return xhr;};}
s.data=null;var beforeSend=s.beforeSend;s.beforeSend=function(xhr,o){if(options.formData)
o.data=options.formData;else
o.data=formdata;if(beforeSend)
beforeSend.call(this,xhr,o);};return $.ajax(s);}
function fileUploadIframe(a){var form=$form[0],el,i,s,g,id,$io,io,xhr,sub,n,timedOut,timeoutHandle;var deferred=$.Deferred();deferred.abort=function(status){xhr.abort(status);};if(a){for(i=0;i<elements.length;i++){el=$(elements[i]);if(hasProp)
el.prop('disabled',false);else
el.removeAttr('disabled');}}
s=$.extend(true,{},$.ajaxSettings,options);s.context=s.context||s;id='jqFormIO'+(new Date().getTime());if(s.iframeTarget){$io=$(s.iframeTarget);n=$io.attr2('name');if(!n)
$io.attr2('name',id);else
id=n;}
else{$io=$('<iframe name="'+id+'" src="'+s.iframeSrc+'" />');$io.css({position:'absolute',top:'-1000px',left:'-1000px'});}
io=$io[0];xhr={aborted:0,responseText:null,responseXML:null,status:0,statusText:'n/a',getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(status){var e=(status==='timeout'?'timeout':'aborted');log('aborting upload... '+e);this.aborted=1;try{if(io.contentWindow.document.execCommand){io.contentWindow.document.execCommand('Stop');}}
catch(ignore){}
$io.attr('src',s.iframeSrc);xhr.error=e;if(s.error)
s.error.call(s.context,xhr,e,status);if(g)
$.event.trigger("ajaxError",[xhr,s,e]);if(s.complete)
s.complete.call(s.context,xhr,e);}};g=s.global;if(g&&0===$.active++){$.event.trigger("ajaxStart");}
if(g){$.event.trigger("ajaxSend",[xhr,s]);}
if(s.beforeSend&&s.beforeSend.call(s.context,xhr,s)===false){if(s.global){$.active--;}
deferred.reject();return deferred;}
if(xhr.aborted){deferred.reject();return deferred;}
sub=form.clk;if(sub){n=sub.name;if(n&&!sub.disabled){s.extraData=s.extraData||{};s.extraData[n]=sub.value;if(sub.type=="image"){s.extraData[n+'.x']=form.clk_x;s.extraData[n+'.y']=form.clk_y;}}}
var CLIENT_TIMEOUT_ABORT=1;var SERVER_ABORT=2;function getDoc(frame){var doc=null;try{if(frame.contentWindow){doc=frame.contentWindow.document;}}catch(err){log('cannot get iframe.contentWindow document: '+err);}
if(doc){return doc;}
try{doc=frame.contentDocument?frame.contentDocument:frame.document;}catch(err){log('cannot get iframe.contentDocument: '+err);doc=frame.document;}
return doc;}
var csrf_token=$('meta[name=csrf-token]').attr('content');var csrf_param=$('meta[name=csrf-param]').attr('content');if(csrf_param&&csrf_token){s.extraData=s.extraData||{};s.extraData[csrf_param]=csrf_token;}
function doSubmit(){var t=$form.attr2('target'),a=$form.attr2('action');form.setAttribute('target',id);if(!method||/post/i.test(method)){form.setAttribute('method','POST');}
if(a!=s.url){form.setAttribute('action',s.url);}
if(!s.skipEncodingOverride&&(!method||/post/i.test(method))){$form.attr({encoding:'multipart/form-data',enctype:'multipart/form-data'});}
if(s.timeout){timeoutHandle=setTimeout(function(){timedOut=true;cb(CLIENT_TIMEOUT_ABORT);},s.timeout);}
function checkState(){try{var state=getDoc(io).readyState;log('state = '+state);if(state&&state.toLowerCase()=='uninitialized')
setTimeout(checkState,50);}
catch(e){log('Server abort: ',e,' (',e.name,')');cb(SERVER_ABORT);if(timeoutHandle)
clearTimeout(timeoutHandle);timeoutHandle=undefined;}}
var extraInputs=[];try{if(s.extraData){for(var n in s.extraData){if(s.extraData.hasOwnProperty(n)){if($.isPlainObject(s.extraData[n])&&s.extraData[n].hasOwnProperty('name')&&s.extraData[n].hasOwnProperty('value')){extraInputs.push($('<input type="hidden" name="'+s.extraData[n].name+'">').val(s.extraData[n].value).appendTo(form)[0]);}else{extraInputs.push($('<input type="hidden" name="'+n+'">').val(s.extraData[n]).appendTo(form)[0]);}}}}
if(!s.iframeTarget){$io.appendTo('body');}
if(io.attachEvent)
io.attachEvent('onload',cb);else
io.addEventListener('load',cb,false);setTimeout(checkState,15);try{form.submit();}catch(err){var submitFn=document.createElement('form').submit;submitFn.apply(form);}}
finally{form.setAttribute('action',a);if(t){form.setAttribute('target',t);}else{$form.removeAttr('target');}
$(extraInputs).remove();}}
if(s.forceSync){doSubmit();}
else{setTimeout(doSubmit,10);}
var data,doc,domCheckCount=50,callbackProcessed;function cb(e){if(xhr.aborted||callbackProcessed){return;}
doc=getDoc(io);if(!doc){log('cannot access response document');e=SERVER_ABORT;}
if(e===CLIENT_TIMEOUT_ABORT&&xhr){xhr.abort('timeout');deferred.reject(xhr,'timeout');return;}
else if(e==SERVER_ABORT&&xhr){xhr.abort('server abort');deferred.reject(xhr,'error','server abort');return;}
if(!doc||doc.location.href==s.iframeSrc){if(!timedOut)
return;}
if(io.detachEvent)
io.detachEvent('onload',cb);else
io.removeEventListener('load',cb,false);var status='success',errMsg;try{if(timedOut){throw'timeout';}
var isXml=s.dataType=='xml'||doc.XMLDocument||$.isXMLDoc(doc);log('isXml='+isXml);if(!isXml&&window.opera&&(doc.body===null||!doc.body.innerHTML)){if(--domCheckCount){log('requeing onLoad callback, DOM not available');setTimeout(cb,250);return;}}
var docRoot=doc.body?doc.body:doc.documentElement;xhr.responseText=docRoot?docRoot.innerHTML:null;xhr.responseXML=doc.XMLDocument?doc.XMLDocument:doc;if(isXml)
s.dataType='xml';xhr.getResponseHeader=function(header){var headers={'content-type':s.dataType};return headers[header.toLowerCase()];};if(docRoot){xhr.status=Number(docRoot.getAttribute('status'))||xhr.status;xhr.statusText=docRoot.getAttribute('statusText')||xhr.statusText;}
var dt=(s.dataType||'').toLowerCase();var scr=/(json|script|text)/.test(dt);if(scr||s.textarea){var ta=doc.getElementsByTagName('textarea')[0];if(ta){xhr.responseText=ta.value;xhr.status=Number(ta.getAttribute('status'))||xhr.status;xhr.statusText=ta.getAttribute('statusText')||xhr.statusText;}
else if(scr){var pre=doc.getElementsByTagName('pre')[0];var b=doc.getElementsByTagName('body')[0];if(pre){xhr.responseText=pre.textContent?pre.textContent:pre.innerText;}
else if(b){xhr.responseText=b.textContent?b.textContent:b.innerText;}}}
else if(dt=='xml'&&!xhr.responseXML&&xhr.responseText){xhr.responseXML=toXml(xhr.responseText);}
try{data=httpData(xhr,dt,s);}
catch(err){status='parsererror';xhr.error=errMsg=(err||status);}}
catch(err){log('error caught: ',err);status='error';xhr.error=errMsg=(err||status);}
if(xhr.aborted){log('upload aborted');status=null;}
if(xhr.status){status=(xhr.status>=200&&xhr.status<300||xhr.status===304)?'success':'error';}
if(status==='success'){if(s.success)
s.success.call(s.context,data,'success',xhr);deferred.resolve(xhr.responseText,'success',xhr);if(g)
$.event.trigger("ajaxSuccess",[xhr,s]);}
else if(status){if(errMsg===undefined)
errMsg=xhr.statusText;if(s.error)
s.error.call(s.context,xhr,status,errMsg);deferred.reject(xhr,'error',errMsg);if(g)
$.event.trigger("ajaxError",[xhr,s,errMsg]);}
if(g)
$.event.trigger("ajaxComplete",[xhr,s]);if(g&&!--$.active){$.event.trigger("ajaxStop");}
if(s.complete)
s.complete.call(s.context,xhr,status);callbackProcessed=true;if(s.timeout)
clearTimeout(timeoutHandle);setTimeout(function(){if(!s.iframeTarget)
$io.remove();else
$io.attr('src',s.iframeSrc);xhr.responseXML=null;},100);}
var toXml=$.parseXML||function(s,doc){if(window.ActiveXObject){doc=new ActiveXObject('Microsoft.XMLDOM');doc.async='false';doc.loadXML(s);}
else{doc=(new DOMParser()).parseFromString(s,'text/xml');}
return(doc&&doc.documentElement&&doc.documentElement.nodeName!='parsererror')?doc:null;};var parseJSON=$.parseJSON||function(s){return window['eval']('('+s+')');};var httpData=function(xhr,type,s){var ct=xhr.getResponseHeader('content-type')||'',xml=type==='xml'||!type&&ct.indexOf('xml')>=0,data=xml?xhr.responseXML:xhr.responseText;if(xml&&data.documentElement.nodeName==='parsererror'){if($.error)
$.error('parsererror');}
if(s&&s.dataFilter){data=s.dataFilter(data,type);}
if(typeof data==='string'){if(type==='json'||!type&&ct.indexOf('json')>=0){data=parseJSON(data);}else if(type==="script"||!type&&ct.indexOf("javascript")>=0){$.globalEval(data);}}
return data;};return deferred;}};$.fn.ajaxForm=function(options){options=options||{};options.delegation=options.delegation&&$.isFunction($.fn.on);if(!options.delegation&&this.length===0){var o={s:this.selector,c:this.context};if(!$.isReady&&o.s){log('DOM not ready, queuing ajaxForm');$(function(){$(o.s,o.c).ajaxForm(options);});return this;}
log('terminating; zero elements found by selector'+($.isReady?'':' (DOM not ready)'));return this;}
if(options.delegation){$(document).off('submit.form-plugin',this.selector,doAjaxSubmit).off('click.form-plugin',this.selector,captureSubmittingElement).on('submit.form-plugin',this.selector,options,doAjaxSubmit).on('click.form-plugin',this.selector,options,captureSubmittingElement);return this;}
return this.ajaxFormUnbind().bind('submit.form-plugin',options,doAjaxSubmit).bind('click.form-plugin',options,captureSubmittingElement);};function doAjaxSubmit(e){var options=e.data;if(!e.isDefaultPrevented()){e.preventDefault();$(e.target).ajaxSubmit(options);}}
function captureSubmittingElement(e){var target=e.target;var $el=$(target);if(!($el.is("[type=submit],[type=image]"))){var t=$el.closest('[type=submit]');if(t.length===0){return;}
target=t[0];}
var form=this;form.clk=target;if(target.type=='image'){if(e.offsetX!==undefined){form.clk_x=e.offsetX;form.clk_y=e.offsetY;}else if(typeof $.fn.offset=='function'){var offset=$el.offset();form.clk_x=e.pageX-offset.left;form.clk_y=e.pageY-offset.top;}else{form.clk_x=e.pageX-target.offsetLeft;form.clk_y=e.pageY-target.offsetTop;}}
setTimeout(function(){form.clk=form.clk_x=form.clk_y=null;},100);}
$.fn.ajaxFormUnbind=function(){return this.unbind('submit.form-plugin click.form-plugin');};$.fn.formToArray=function(semantic,elements){var a=[];if(this.length===0){return a;}
var form=this[0];var els=semantic?form.getElementsByTagName('*'):form.elements;if(!els){return a;}
var i,j,n,v,el,max,jmax;for(i=0,max=els.length;i<max;i++){el=els[i];n=el.name;if(!n||el.disabled){continue;}
if(semantic&&form.clk&&el.type=="image"){if(form.clk==el){a.push({name:n,value:$(el).val(),type:el.type});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}
continue;}
v=$.fieldValue(el,true);if(v&&v.constructor==Array){if(elements)
elements.push(el);for(j=0,jmax=v.length;j<jmax;j++){a.push({name:n,value:v[j]});}}
else if(feature.fileapi&&el.type=='file'){if(elements)
elements.push(el);var files=el.files;if(files.length){for(j=0;j<files.length;j++){a.push({name:n,value:files[j],type:el.type});}}
else{a.push({name:n,value:'',type:el.type});}}
else if(v!==null&&typeof v!='undefined'){if(elements)
elements.push(el);a.push({name:n,value:v,type:el.type,required:el.required});}}
if(!semantic&&form.clk){var $input=$(form.clk),input=$input[0];n=input.name;if(n&&!input.disabled&&input.type=='image'){a.push({name:n,value:$input.val()});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}}
return a;};$.fn.formSerialize=function(semantic){return $.param(this.formToArray(semantic));};$.fn.fieldSerialize=function(successful){var a=[];this.each(function(){var n=this.name;if(!n){return;}
var v=$.fieldValue(this,successful);if(v&&v.constructor==Array){for(var i=0,max=v.length;i<max;i++){a.push({name:n,value:v[i]});}}
else if(v!==null&&typeof v!='undefined'){a.push({name:this.name,value:v});}});return $.param(a);};$.fn.fieldValue=function(successful){for(var val=[],i=0,max=this.length;i<max;i++){var el=this[i];var v=$.fieldValue(el,successful);if(v===null||typeof v=='undefined'||(v.constructor==Array&&!v.length)){continue;}
if(v.constructor==Array)
$.merge(val,v);else
val.push(v);}
return val;};$.fieldValue=function(el,successful){var n=el.name,t=el.type,tag=el.tagName.toLowerCase();if(successful===undefined){successful=true;}
if(successful&&(!n||el.disabled||t=='reset'||t=='button'||(t=='checkbox'||t=='radio')&&!el.checked||(t=='submit'||t=='image')&&el.form&&el.form.clk!=el||tag=='select'&&el.selectedIndex==-1)){return null;}
if(tag=='select'){var index=el.selectedIndex;if(index<0){return null;}
var a=[],ops=el.options;var one=(t=='select-one');var max=(one?index+1:ops.length);for(var i=(one?index:0);i<max;i++){var op=ops[i];if(op.selected){var v=op.value;if(!v){v=(op.attributes&&op.attributes['value']&&!(op.attributes['value'].specified))?op.text:op.value;}
if(one){return v;}
a.push(v);}}
return a;}
return $(el).val();};$.fn.clearForm=function(includeHidden){return this.each(function(){$('input,select,textarea',this).clearFields(includeHidden);});};$.fn.clearFields=$.fn.clearInputs=function(includeHidden){var re=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;return this.each(function(){var t=this.type,tag=this.tagName.toLowerCase();if(re.test(t)||tag=='textarea'){this.value='';}
else if(t=='checkbox'||t=='radio'){this.checked=false;}
else if(tag=='select'){this.selectedIndex=-1;}
else if(t=="file"){if(/MSIE/.test(navigator.userAgent)){$(this).replaceWith($(this).clone(true));}else{$(this).val('');}}
else if(includeHidden){if((includeHidden===true&&/hidden/.test(t))||(typeof includeHidden=='string'&&$(this).is(includeHidden)))
this.value='';}});};$.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=='function'||(typeof this.reset=='object'&&!this.reset.nodeType)){this.reset();}});};$.fn.enable=function(b){if(b===undefined){b=true;}
return this.each(function(){this.disabled=!b;});};$.fn.selected=function(select){if(select===undefined){select=true;}
return this.each(function(){var t=this.type;if(t=='checkbox'||t=='radio'){this.checked=select;}
else if(this.tagName.toLowerCase()=='option'){var $sel=$(this).parent('select');if(select&&$sel[0]&&$sel[0].type=='select-one'){$sel.find('option').selected(false);}
this.selected=select;}});};$.fn.ajaxSubmit.debug=false;function log(){if(!$.fn.ajaxSubmit.debug)
return;var msg='[jquery.form] '+Array.prototype.join.call(arguments,'');if(window.console&&window.console.log){window.console.log(msg);}
else if(window.opera&&window.opera.postError){window.opera.postError(msg);}}}));;var qq=function(e){return{hide:function(){return e.style.display="none",this},attach:function(t,n){return e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n),function(){qq(e).detach(t,n)}},detach:function(t,n){return e.removeEventListener?e.removeEventListener(t,n,!1):e.attachEvent&&e.detachEvent("on"+t,n),this},contains:function(t){return e===t?!0:e.contains?e.contains(t):!!(8&t.compareDocumentPosition(e))},insertBefore:function(t){return t.parentNode.insertBefore(e,t),this},remove:function(){return e.parentNode.removeChild(e),this},css:function(t){return null!==t.opacity&&"string"!=typeof e.style.opacity&&"undefined"!=typeof e.filters&&(t.filter="alpha(opacity="+Math.round(100*t.opacity)+")"),qq.extend(e.style,t),this},hasClass:function(t){return RegExp("(^| )"+t+"( |$)").test(e.className)},addClass:function(t){return qq(e).hasClass(t)||(e.className+=" "+t),this},removeClass:function(t){return e.className=e.className.replace(RegExp("(^| )"+t+"( |$)")," ").replace(/^\s+|\s+$/g,""),this},getByClass:function(t){var n,o=[];return e.querySelectorAll?e.querySelectorAll("."+t):(n=e.getElementsByTagName("*"),qq.each(n,function(e,n){qq(n).hasClass(t)&&o.push(n)}),o)},children:function(){for(var t=[],n=e.firstChild;n;)1===n.nodeType&&t.push(n),n=n.nextSibling;return t},setText:function(t){return e.innerText=t,e.textContent=t,this},clearText:function(){return qq(e).setText("")}}};qq.log=function(e,t){window.console&&(t&&"info"!==t?window.console[t]?window.console[t](e):window.console.log("<"+t+"> "+e):window.console.log(e))},qq.isObject=function(e){return null!==e&&e&&"object"==typeof e&&e.constructor===Object},qq.isFunction=function(e){return"function"==typeof e},qq.isString=function(e){return"[object String]"===Object.prototype.toString.call(e)},qq.trimStr=function(e){return String.prototype.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},qq.isFileOrInput=function(e){if(window.File&&e instanceof File)return!0;if(window.HTMLInputElement){if(e instanceof HTMLInputElement&&e.type&&"file"===e.type.toLowerCase())return!0}else if(e.tagName&&"input"===e.tagName.toLowerCase()&&e.type&&"file"===e.type.toLowerCase())return!0;return!1},qq.isBlob=function(e){return window.Blob&&"[object Blob]"===Object.prototype.toString.call(e)},qq.isXhrUploadSupported=function(){var e=document.createElement("input");return e.type="file",void 0!==e.multiple&&"undefined"!=typeof File&&"undefined"!=typeof FormData&&"undefined"!=typeof(new XMLHttpRequest).upload},qq.isFolderDropSupported=function(e){return e.items&&e.items[0].webkitGetAsEntry},qq.isFileChunkingSupported=function(){return!qq.android()&&qq.isXhrUploadSupported()&&(void 0!==File.prototype.slice||void 0!==File.prototype.webkitSlice||void 0!==File.prototype.mozSlice)},qq.extend=function(e,t,n){qq.each(t,function(t,o){n&&qq.isObject(o)?(void 0===e[t]&&(e[t]={}),qq.extend(e[t],o,!0)):e[t]=o})},qq.indexOf=function(e,t,n){if(e.indexOf)return e.indexOf(t,n);var n=n||0,o=e.length;for(0>n&&(n+=o);o>n;n+=1)if(e.hasOwnProperty(n)&&e[n]===t)return n;return-1},qq.getUniqueId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},qq.ie=function(){return-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.userAgent.indexOf("Trident")},qq.ie10=function(){return-1!==navigator.userAgent.indexOf("MSIE 10")},qq.ie11=function(){return-1!==navigator.userAgent.indexOf("rv:11")},qq.safari=function(){return void 0!==navigator.vendor&&-1!==navigator.vendor.indexOf("Apple")},qq.chrome=function(){return void 0!==navigator.vendor&&-1!==navigator.vendor.indexOf("Google")},qq.firefox=function(){return-1!==navigator.userAgent.indexOf("Mozilla")&&void 0!==navigator.vendor&&""===navigator.vendor},qq.windows=function(){return"Win32"===navigator.platform},qq.android=function(){return-1!==navigator.userAgent.toLowerCase().indexOf("android")},qq.preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},qq.toElement=function(){var e=document.createElement("div");return function(t){return e.innerHTML=t,t=e.firstChild,e.removeChild(t),t}}(),qq.each=function(e,t){var n,o;if(e)for(n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&(o=t(n,e[n]),!1===o))break},qq.obj2url=function(e,t,n){var o,i=[],s="&",r=function(e,n){var o=t?/\[\]$/.test(t)?t:t+"["+n+"]":n;"undefined"!==o&&"undefined"!==n&&i.push("object"==typeof e?qq.obj2url(e,o,!0):"[object Function]"===Object.prototype.toString.call(e)?encodeURIComponent(o)+"="+encodeURIComponent(e()):encodeURIComponent(o)+"="+encodeURIComponent(e))};if(!n&&t)s=/\?/.test(t)?/\?$/.test(t)?"":"&":"?",i.push(t),i.push(qq.obj2url(e));else if("[object Array]"===Object.prototype.toString.call(e)&&"undefined"!=typeof e)for(o=-1,n=e.length;n>o;o+=1)r(e[o],o);else if("undefined"!=typeof e&&null!==e&&"object"==typeof e)for(o in e)e.hasOwnProperty(o)&&r(e[o],o);else i.push(encodeURIComponent(t)+"="+encodeURIComponent(e));return t?i.join(s):i.join(s).replace(/^&/,"").replace(/%20/g,"+")},qq.obj2FormData=function(e,t,n){return t||(t=new FormData),qq.each(e,function(e,o){e=n?n+"["+e+"]":e,qq.isObject(o)?qq.obj2FormData(o,t,e):qq.isFunction(o)?t.append(e,o()):t.append(e,o)}),t},qq.obj2Inputs=function(e,t){var n;return t||(t=document.createElement("form")),qq.obj2FormData(e,{append:function(e,o){n=document.createElement("input"),n.setAttribute("name",e),n.setAttribute("value",o),t.appendChild(n)}}),t},qq.setCookie=function(e,t,n){var o=new Date,i="";n&&(o.setTime(o.getTime()+864e5*n),i="; expires="+o.toGMTString()),document.cookie=e+"="+t+i+"; path=/"},qq.getCookie=function(e){for(var t,e=e+"=",n=document.cookie.split(";"),o=0;o<n.length;o++){for(t=n[o];" "==t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(e))return t.substring(e.length,t.length)}},qq.getCookieNames=function(e){var t=document.cookie.split(";"),n=[];return qq.each(t,function(t,o){var o=qq.trimStr(o),i=o.indexOf("=");o.match(e)&&n.push(o.substr(0,i))}),n},qq.deleteCookie=function(e){qq.setCookie(e,"",-1)},qq.areCookiesEnabled=function(){var e="qqCookieTest:"+1e5*Math.random();return qq.setCookie(e,1),qq.getCookie(e)?(qq.deleteCookie(e),!0):!1},qq.parseJson=function(a){return window.JSON&&qq.isFunction(JSON.parse)?JSON.parse(a):eval("("+a+")")},qq.DisposeSupport=function(){var e=[];return{dispose:function(){var t;do(t=e.shift())&&t();while(t)},attach:function(){this.addDisposer(qq(arguments[0]).attach.apply(this,Array.prototype.slice.call(arguments,1)))},addDisposer:function(t){e.push(t)}}},qq.supportedFeatures=function(){var e,t,n,o,i,s;e=!0;try{t=document.createElement("input"),t.type="file",qq(t).hide(),t.disabled&&(e=!1)}catch(r){e=!1}return n=(t=e&&qq.isXhrUploadSupported())&&qq.chrome()&&void 0!==navigator.userAgent.match(/Chrome\/[2][1-9]|Chrome\/[3-9][0-9]/),o=t&&qq.isFileChunkingSupported(),i=t&&o&&qq.areCookiesEnabled(),s=t&&qq.chrome()&&void 0!==navigator.userAgent.match(/Chrome\/[1][4-9]|Chrome\/[2-9][0-9]/),{uploading:e,ajaxUploading:t,fileDrop:t,folderDrop:n,chunking:o,resume:i,uploadCustomHeaders:t,uploadNonMultipart:t,itemSizeValidation:t,uploadViaPaste:s,progressBar:t,uploadCors:e&&(void 0!==window.postMessage||t),deleteFileCors:t}}(),qq.Promise=function(){var e,t,n,o,i,s=0;return{then:function(i,r){return 0===s?(n=i,o=r):-1===s&&r?r(t):i&&i(e),this},done:function(e){return 0===s?i=e:e(),this},success:function(t){return s=1,e=t,n&&n(t),i&&i(),this},failure:function(e){return s=-1,t=e,o&&o(e),i&&i(),this}}},qq.UploadButton=function(e){function t(){var e=document.createElement("input");return i.multiple&&e.setAttribute("multiple","multiple"),i.acceptFiles&&e.setAttribute("accept",i.acceptFiles),e.setAttribute("type","file"),e.setAttribute("name",i.name),qq(e).css({position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0}),i.element.appendChild(e),o.attach(e,"change",function(){i.onChange(e)}),o.attach(e,"mouseover",function(){qq(i.element).addClass(i.hoverClass)}),o.attach(e,"mouseout",function(){qq(i.element).removeClass(i.hoverClass)}),o.attach(e,"focus",function(){qq(i.element).addClass(i.focusClass)}),o.attach(e,"blur",function(){qq(i.element).removeClass(i.focusClass)}),window.attachEvent&&e.setAttribute("tabIndex","-1"),e}var n,o=new qq.DisposeSupport,i={element:null,multiple:!1,acceptFiles:null,name:"file",onChange:function(){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"};return qq.extend(i,e),qq(i.element).css({position:"relative",overflow:"hidden",direction:"ltr"}),n=t(),{getInput:function(){return n},reset:function(){n.parentNode&&qq(n).remove(),qq(i.element).removeClass(i.focusClass),n=t()}}},qq.PasteSupport=function(e){var t;return t={targetElement:null,callbacks:{log:function(){},pasteReceived:function(){}}},qq.extend(t,e),function(){qq(t.targetElement).attach("paste",function(e){(e=e.clipboardData)&&qq.each(e.items,function(e,n){if(n.type&&0===n.type.indexOf("image/")){var o=n.getAsFile();t.callbacks.pasteReceived(o)}})})}(),{reset:function(){}}},qq.FineUploaderBasic=function(e){this._options={debug:!1,button:null,multiple:!0,maxConnections:3,disableCancelForFormUploads:!1,autoUpload:!0,request:{endpoint:"/server/upload",params:{},paramsInBody:!0,customHeaders:{},forceMultipart:!0,inputName:"qqfile",uuidName:"qquuid",totalFileSizeName:"qqtotalfilesize"},validation:{allowedExtensions:[],sizeLimit:0,minSizeLimit:0,itemLimit:0,stopOnFirstInvalidFile:!0},callbacks:{onSubmit:function(){},onSubmitted:function(){},onComplete:function(){},onCancel:function(){},onUpload:function(){},onUploadChunk:function(){},onResume:function(){},onProgress:function(){},onError:function(){},onAutoRetry:function(){},onManualRetry:function(){},onValidateBatch:function(){},onValidate:function(){},onSubmitDelete:function(){},onDelete:function(){},onDeleteComplete:function(){},onPasteReceived:function(){}},messages:{typeError:"{file} has an invalid extension. Valid extension(s): {extensions}.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} пуст, пожалуйста выберите не пустой файл.",noFilesError:"No files to upload.",tooManyItemsError:"Too many items ({netItems}) would be uploaded.  Item limit is {itemLimit}.",retryFailTooManyItems:"Retry failed - you have reached your file limit.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},retry:{enableAuto:!1,maxAutoAttempts:3,autoAttemptDelay:5,preventRetryResponseProperty:"preventRetry"},classes:{buttonHover:"qq-upload-button-hover",buttonFocus:"qq-upload-button-focus"},chunking:{enabled:!1,partSize:2e6,paramNames:{partIndex:"qqpartindex",partByteOffset:"qqpartbyteoffset",chunkSize:"qqchunksize",totalFileSize:"qqtotalfilesize",totalParts:"qqtotalparts",filename:"qqfilename"}},resume:{enabled:!1,id:null,cookiesExpireIn:7,paramNames:{resuming:"qqresume"}},formatFileName:function(e){return 33<e.length&&(e=e.slice(0,19)+"..."+e.slice(-14)),e},text:{defaultResponseError:"Upload failure reason unknown",sizeSymbols:"kB MB GB TB PB EB".split(" ")},deleteFile:{enabled:!1,endpoint:"/server/upload",customHeaders:{},params:{}},cors:{expected:!1,sendCredentials:!1},blobs:{defaultName:"misc_data",paramNames:{name:"qqblobname"}},paste:{targetElement:null,defaultName:"pasted_image"}},qq.extend(this._options,e,!0),this._wrapCallbacks(),this._disposeSupport=new qq.DisposeSupport,this._filesInProgress=[],this._storedIds=[],this._autoRetries=[],this._retryTimeouts=[],this._preventRetries=[],this._netUploaded=this._netUploadedOrQueued=0,this._paramsStore=this._createParamsStore("request"),this._deleteFileParamsStore=this._createParamsStore("deleteFile"),this._endpointStore=this._createEndpointStore("request"),this._deleteFileEndpointStore=this._createEndpointStore("deleteFile"),this._handler=this._createUploadHandler(),this._deleteHandler=this._createDeleteHandler(),this._options.button&&(this._button=this._createUploadButton(this._options.button)),this._options.paste.targetElement&&(this._pasteHandler=this._createPasteHandler()),this._preventLeaveInProgress()},qq.FineUploaderBasic.prototype={log:function(e,t){!this._options.debug||t&&"info"!==t?t&&"info"!==t&&qq.log("[FineUploader] "+e,t):qq.log("[FineUploader] "+e)},setParams:function(e,t){null==t?this._options.request.params=e:this._paramsStore.setParams(e,t)},setDeleteFileParams:function(e,t){null==t?this._options.deleteFile.params=e:this._deleteFileParamsStore.setParams(e,t)},setEndpoint:function(e,t){null==t?this._options.request.endpoint=e:this._endpointStore.setEndpoint(e,t)},getInProgress:function(){return this._filesInProgress.length},getNetUploads:function(){return this._netUploaded},uploadStoredFiles:function(){for(var e;this._storedIds.length;)e=this._storedIds.shift(),this._filesInProgress.push(e),this._handler.upload(e)},clearStoredFiles:function(){this._storedIds=[]},retry:function(e){return this._onBeforeManualRetry(e)?(this._netUploadedOrQueued++,this._handler.retry(e),!0):!1},cancel:function(e){this._handler.cancel(e)},cancelAll:function(){var e=[],t=this;qq.extend(e,this._storedIds),qq.each(e,function(e,n){t.cancel(n)}),this._handler.cancelAll()},reset:function(){this.log("Resetting uploader..."),this._handler.reset(),this._filesInProgress=[],this._storedIds=[],this._autoRetries=[],this._retryTimeouts=[],this._preventRetries=[],this._button.reset(),this._paramsStore.reset(),this._endpointStore.reset(),this._netUploaded=this._netUploadedOrQueued=0,this._pasteHandler&&this._pasteHandler.reset()},addFiles:function(e,t,n){var o,i,s=[];if(e){for(window.FileList&&e instanceof FileList||(e=[].concat(e)),o=0;o<e.length;o+=1)i=e[o],qq.isFileOrInput(i)?s.push(i):this.log(i+" is not a File or INPUT element!  Ignoring!","warn");this.log("Processing "+s.length+" files or inputs..."),this._uploadFileOrBlobDataList(s,t,n)}},addBlobs:function(e,t,n){if(e){var e=[].concat(e),o=[],i=this;qq.each(e,function(e,t){qq.isBlob(t)&&!qq.isFileOrInput(t)?o.push({blob:t,name:i._options.blobs.defaultName}):qq.isObject(t)&&t.blob&&t.name?o.push(t):i.log("addBlobs: entry at index "+e+" is not a Blob or a BlobData object","error")}),this._uploadFileOrBlobDataList(o,t,n)}else this.log("undefined or non-array parameter passed into addBlobs","error")},getUuid:function(e){return this._handler.getUuid(e)},getResumableFilesData:function(){return this._handler.getResumableFilesData()},getSize:function(e){return this._handler.getSize(e)},getName:function(e){return this._handler.getName(e)},getFile:function(e){return this._handler.getFile(e)},deleteFile:function(e){this._onSubmitDelete(e)},setDeleteFileEndpoint:function(e,t){null==t?this._options.deleteFile.endpoint=e:this._deleteFileEndpointStore.setEndpoint(e,t)},_createUploadButton:function(e){var t=this,n=new qq.UploadButton({element:e,multiple:this._options.multiple&&qq.supportedFeatures.ajaxUploading,acceptFiles:this._options.validation.acceptFiles,onChange:function(e){t._onInputChange(e)},hoverClass:this._options.classes.buttonHover,focusClass:this._options.classes.buttonFocus});return this._disposeSupport.addDisposer(function(){n.dispose()}),n},_createUploadHandler:function(){var e=this;return new qq.UploadHandler({debug:this._options.debug,forceMultipart:this._options.request.forceMultipart,maxConnections:this._options.maxConnections,customHeaders:this._options.request.customHeaders,inputName:this._options.request.inputName,uuidParamName:this._options.request.uuidName,totalFileSizeParamName:this._options.request.totalFileSizeName,cors:this._options.cors,demoMode:this._options.demoMode,paramsInBody:this._options.request.paramsInBody,paramsStore:this._paramsStore,endpointStore:this._endpointStore,chunking:this._options.chunking,resume:this._options.resume,blobs:this._options.blobs,log:function(t,n){e.log(t,n)},onProgress:function(t,n,o,i){e._onProgress(t,n,o,i),e._options.callbacks.onProgress(t,n,o,i)},onComplete:function(t,n,o,i){e._onComplete(t,n,o,i),e._options.callbacks.onComplete(t,n,o,i)},onCancel:function(t,n){e._onCancel(t,n),e._options.callbacks.onCancel(t,n)},onUpload:function(t,n){e._onUpload(t,n),e._options.callbacks.onUpload(t,n)},onUploadChunk:function(t,n,o){e._options.callbacks.onUploadChunk(t,n,o)},onResume:function(t,n,o){return e._options.callbacks.onResume(t,n,o)},onAutoRetry:function(t,n,o,i){return e._preventRetries[t]=o[e._options.retry.preventRetryResponseProperty],e._shouldAutoRetry(t,n,o)?(e._maybeParseAndSendUploadError(t,n,o,i),e._options.callbacks.onAutoRetry(t,n,e._autoRetries[t]+1),e._onBeforeAutoRetry(t,n),e._retryTimeouts[t]=setTimeout(function(){e._onAutoRetry(t,n,o)},1e3*e._options.retry.autoAttemptDelay),!0):!1}})},_createDeleteHandler:function(){var e=this;return new qq.DeleteFileAjaxRequestor({maxConnections:this._options.maxConnections,customHeaders:this._options.deleteFile.customHeaders,paramsStore:this._deleteFileParamsStore,endpointStore:this._deleteFileEndpointStore,demoMode:this._options.demoMode,cors:this._options.cors,log:function(t,n){e.log(t,n)},onDelete:function(t){e._onDelete(t),e._options.callbacks.onDelete(t)},onDeleteComplete:function(t,n,o){e._onDeleteComplete(t,n,o),e._options.callbacks.onDeleteComplete(t,n,o)}})},_createPasteHandler:function(){var e=this;return new qq.PasteSupport({targetElement:this._options.paste.targetElement,callbacks:{log:function(t,n){e.log(t,n)},pasteReceived:function(t){var n=e._options.callbacks.onPasteReceived;(n=n(t))&&n.then?n.then(function(n){e._handlePasteSuccess(t,n)},function(t){e.log("Ignoring pasted image per paste received callback.  Reason = '"+t+"'")}):e._handlePasteSuccess(t)}}})},_handlePasteSuccess:function(e,t){var n=e.type.split("/")[1],o=t;null==o&&(o=this._options.paste.defaultName),this.addBlobs({name:o+("."+n),blob:e})},_preventLeaveInProgress:function(){var e=this;this._disposeSupport.attach(window,"beforeunload",function(t){return e._filesInProgress.length?(t=t||window.event,t.returnValue=e._options.messages.onLeave):void 0})},_onSubmit:function(e){this._netUploadedOrQueued++,this._options.autoUpload&&this._filesInProgress.push(e)},_onProgress:function(){},_onComplete:function(e,t,n,o){n.success?this._netUploaded++:this._netUploadedOrQueued--,this._removeFromFilesInProgress(e),this._maybeParseAndSendUploadError(e,t,n,o)},_onCancel:function(e){this._netUploadedOrQueued--,this._removeFromFilesInProgress(e),clearTimeout(this._retryTimeouts[e]),e=qq.indexOf(this._storedIds,e),!this._options.autoUpload&&e>=0&&this._storedIds.splice(e,1)},_isDeletePossible:function(){return this._options.deleteFile.enabled&&(!this._options.cors.expected||qq.supportedFeatures.deleteFileCors)},_onSubmitDelete:function(e){return this._isDeletePossible()?void(!1!==this._options.callbacks.onSubmitDelete(e)&&this._deleteHandler.sendDelete(e,this.getUuid(e))):(this.log("Delete request ignored for ID "+e+", delete feature is disabled or request not possible due to CORS on a user agent that does not support pre-flighting.","warn"),!1)},_onDelete:function(){},_onDeleteComplete:function(e,t,n){var o=this._handler.getName(e);n?(this.log("Delete request for '"+o+"' has failed.","error"),this._options.callbacks.onError(e,o,"Delete request failed with response code "+t.status,t)):(this._netUploadedOrQueued--,this._netUploaded--,this.log("Delete request for '"+o+"' has succeeded."))},_removeFromFilesInProgress:function(e){e=qq.indexOf(this._filesInProgress,e),e>=0&&this._filesInProgress.splice(e,1)},_onUpload:function(){},_onInputChange:function(e){this.addFiles(qq.supportedFeatures.ajaxUploading?e.files:e),this._button.reset()},_onBeforeAutoRetry:function(e,t){this.log("Waiting "+this._options.retry.autoAttemptDelay+" seconds before retrying "+t+"...")},_onAutoRetry:function(e,t){this.log("Retrying "+t+"..."),this._autoRetries[e]++,this._handler.retry(e)},_shouldAutoRetry:function(e){return!this._preventRetries[e]&&this._options.retry.enableAuto?(void 0===this._autoRetries[e]&&(this._autoRetries[e]=0),this._autoRetries[e]<this._options.retry.maxAutoAttempts):!1},_onBeforeManualRetry:function(e){var t=this._options.validation.itemLimit;if(this._preventRetries[e])return this.log("Retries are forbidden for id "+e,"warn"),!1;if(this._handler.isValid(e)){var n=this._handler.getName(e);return!1===this._options.callbacks.onManualRetry(e,n)?!1:t>0&&this._netUploadedOrQueued+1>t?(this._itemError("retryFailTooManyItems",""),!1):(this.log("Retrying upload for '"+n+"' (id: "+e+")..."),this._filesInProgress.push(e),!0)}return this.log("'"+e+"' is not a valid file ID","error"),!1},_maybeParseAndSendUploadError:function(e,t,n,o){n.success||(o&&200!==o.status&&!n.error?this._options.callbacks.onError(e,t,"XHR returned response code "+o.status,o):this._options.callbacks.onError(e,t,n.error?n.error:this._options.text.defaultResponseError,o))},_uploadFileOrBlobDataList:function(e,t,n){var o;if(this._isBatchValid(this._getValidationDescriptors(e)))if(0<e.length){for(o=0;o<e.length;o++)if(this._validateFileOrBlobData(e[o]))this._upload(e[o],t,n);else if(this._options.validation.stopOnFirstInvalidFile)break}else this._itemError("noFilesError","")},_upload:function(e,t,n){var e=this._handler.add(e),o=this._handler.getName(e);t&&this.setParams(t,e),n&&this.setEndpoint(n,e),!1!==this._options.callbacks.onSubmit(e,o)&&(this._onSubmit(e,o),this._options.callbacks.onSubmitted(e,o),this._options.autoUpload?this._handler.upload(e):this._storeForLater(e))},_storeForLater:function(e){this._storedIds.push(e)},_isBatchValid:function(e){var t;t=this._options.validation.itemLimit;var n=this._netUploadedOrQueued+e.length;return(e=!1!==this._options.callbacks.onValidateBatch(e))&&(0===t||t>=n?e=!0:(e=!1,t=this._options.messages.tooManyItemsError.replace(/\{netItems\}/g,n).replace(/\{itemLimit\}/g,t),this._batchError(t))),e},_validateFileOrBlobData:function(e){var t,n,o;return t=this._getValidationDescriptor(e),n=t.name,o=t.size,!1===this._options.callbacks.onValidate(t)?!1:qq.isFileOrInput(e)&&!this._isAllowedExtension(n)?(this._itemError("typeError",n),!1):0===o?(this._itemError("emptyError",n),!1):o&&this._options.validation.sizeLimit&&o>this._options.validation.sizeLimit?(this._itemError("sizeError",n),!1):o&&o<this._options.validation.minSizeLimit?(this._itemError("minSizeError",n),!1):!0},_itemError:function(e,t){function n(e,t){i=i.replace(e,t)}var o,i=this._options.messages[e],s=[],r=[].concat(t),a=r[0];return qq.each(this._options.validation.allowedExtensions,function(e,t){qq.isString(t)&&s.push(t)}),o=s.join(", ").toLowerCase(),n("{file}",this._options.formatFileName(a)),n("{extensions}",o),n("{sizeLimit}",this._formatSize(this._options.validation.sizeLimit)),n("{minSizeLimit}",this._formatSize(this._options.validation.minSizeLimit)),o=i.match(/(\{\w+\})/g),null!==o&&qq.each(o,function(e,t){n(t,r[e])}),this._options.callbacks.onError(null,a,i),i},_batchError:function(e){this._options.callbacks.onError(null,null,e)},_isAllowedExtension:function(e){var t=this._options.validation.allowedExtensions,n=!1;return t.length?(qq.each(t,function(t,o){return qq.isString(o)&&null!=e.match(RegExp("\\."+o+"$","i"))?(n=!0,!1):void 0}),n):!0},_formatSize:function(e){var t=-1;do e/=1024,t++;while(e>99);return Math.max(e,.1).toFixed(1)+this._options.text.sizeSymbols[t]},_wrapCallbacks:function(){var e,t;e=this,t=function(t,n,o){try{return n.apply(e,o)}catch(i){e.log("Caught exception in '"+t+"' callback - "+i.message,"error")}};for(var n in this._options.callbacks)(function(){var o,i;o=n,i=e._options.callbacks[o],e._options.callbacks[o]=function(){return t(o,i,arguments)}})()},_parseFileOrBlobDataName:function(e){return qq.isFileOrInput(e)?e.value?e.value.replace(/.*(\/|\\)/,""):null!==e.fileName&&void 0!==e.fileName?e.fileName:e.name:e.name},_parseFileOrBlobDataSize:function(e){var t;return qq.isFileOrInput(e)?e.value||(t=null!==e.fileSize&&void 0!==e.fileSize?e.fileSize:e.size):t=e.blob.size,t},_getValidationDescriptor:function(e){var t,n;return n={},t=this._parseFileOrBlobDataName(e),e=this._parseFileOrBlobDataSize(e),n.name=t,void 0!==e&&(n.size=e),n},_getValidationDescriptors:function(e){var t=this,n=[];return qq.each(e,function(e,o){n.push(t._getValidationDescriptor(o))}),n},_createParamsStore:function(e){var t={},n=this;return{setParams:function(e,n){var o={};qq.extend(o,e),t[n]=o},getParams:function(o){var i={};return null!=o&&t[o]?qq.extend(i,t[o]):qq.extend(i,n._options[e].params),i},remove:function(e){return delete t[e]},reset:function(){t={}}}},_createEndpointStore:function(e){var t={},n=this;return{setEndpoint:function(e,n){t[n]=e},getEndpoint:function(o){return null!=o&&t[o]?t[o]:n._options[e].endpoint},remove:function(e){return delete t[e]},reset:function(){t={}}}}},qq.DragAndDrop=function(e){function t(e){var n,o,i=new qq.Promise;return e.isFile?e.file(function(e){a.push(e),i.success()},function(t){s.callbacks.dropLog("Problem parsing '"+e.fullPath+"'.  FileError code "+t.code+".","error"),i.failure()}):e.isDirectory&&(n=e.createReader(),n.readEntries(function(e){var n=e.length;for(o=0;o<e.length;o+=1)t(e[o]).done(function(){n-=1,0===n&&i.success()});e.length||i.success()},function(t){s.callbacks.dropLog("Problem parsing '"+e.fullPath+"'.  FileError code "+t.code+".","error"),i.failure()})),i}function n(e){var n,o,i=[],l=new qq.Promise;if(s.callbacks.processingDroppedFiles(),r.dropDisabled(!0),1<e.files.length&&!s.allowMultipleItems)s.callbacks.processingDroppedFilesComplete([]),s.callbacks.dropError("tooManyFilesError",""),r.dropDisabled(!1),l.failure();else{if(a=[],qq.isFolderDropSupported(e))for(n=e.items,e=0;e<n.length;e+=1)(o=n[e].webkitGetAsEntry())&&(o.isFile?a.push(n[e].getAsFile()):i.push(t(o).done(function(){i.pop(),0===i.length&&l.success()})));else a=e.files;0===i.length&&l.success()}return l}function o(e){r=new qq.UploadDropZone({element:e,onEnter:function(t){qq(e).addClass(s.classes.dropActive),t.stopPropagation()},onLeaveNotDescendants:function(){qq(e).removeClass(s.classes.dropActive)},onDrop:function(t){s.hideDropZonesBeforeEnter&&qq(e).hide(),qq(e).removeClass(s.classes.dropActive),n(t.dataTransfer).done(function(){var e=a;s.callbacks.dropLog("Grabbed "+e.length+" dropped files."),r.dropDisabled(!1),s.callbacks.processingDroppedFilesComplete(e)})}}),l.addDisposer(function(){r.dispose()}),s.hideDropZonesBeforeEnter&&qq(e).hide()}function i(e){var t;return qq.each(e.dataTransfer.types,function(e,n){return"Files"===n?(t=!0,!1):void 0}),t}var s,r,a=[],l=new qq.DisposeSupport;return s={dropZoneElements:[],hideDropZonesBeforeEnter:!1,allowMultipleItems:!0,classes:{dropActive:null},callbacks:new qq.DragAndDrop.callbacks},qq.extend(s,e,!0),function(){var e=s.dropZoneElements;qq.each(e,function(e,t){o(t)}),e.length&&(!qq.ie()||qq.ie10())&&l.attach(document,"dragenter",function(t){!r.dropDisabled()&&i(t)&&qq.each(e,function(e,t){qq(t).css({display:"block"})})}),l.attach(document,"dragleave",function(t){s.hideDropZonesBeforeEnter&&qq.FineUploader.prototype._leaving_document_out(t)&&qq.each(e,function(e,t){qq(t).hide()})}),l.attach(document,"drop",function(t){s.hideDropZonesBeforeEnter&&qq.each(e,function(e,t){qq(t).hide()}),t.preventDefault()})}(),{setupExtraDropzone:function(e){s.dropZoneElements.push(e),o(e)},removeDropzone:function(e){var t,n=s.dropZoneElements;for(t in n)if(n[t]===e)return n.splice(t,1)},dispose:function(){l.dispose(),r.dispose()}}},qq.DragAndDrop.callbacks=function(){return{processingDroppedFiles:function(){},processingDroppedFilesComplete:function(){},dropError:function(e,t){qq.log("Drag & drop error code '"+e+" with these specifics: '"+t+"'","error")},dropLog:function(e,t){qq.log(e,t)}}},qq.UploadDropZone=function(e){function t(){return qq.safari()||qq.firefox()&&qq.windows()}function n(e){if(qq.ie()&&!qq.ie10()&&!qq.ie11())return!1;var t=e.dataTransfer,n=qq.safari(),e=qq.ie10()||qq.ie11()?!0:"none"!==t.effectAllowed;return t&&e&&(t.files||!n&&t.types.contains&&t.types.contains("Files"))}function o(e){return void 0!==e&&(r=e),r}var i,s,r,a,l=new qq.DisposeSupport;return i={element:null,onEnter:function(){},onLeave:function(){},onLeaveNotDescendants:function(){},onDrop:function(){}},qq.extend(i,e),s=i.element,function(){a||(t?l.attach(document,"dragover",function(e){e.preventDefault()}):l.attach(document,"dragover",function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="none",e.preventDefault())}),a=!0)}(),function(){l.attach(s,"dragover",function(e){if(n(e)){var t=qq.ie()?null:e.dataTransfer.effectAllowed;e.dataTransfer.dropEffect="move"===t||"linkMove"===t?"move":"copy",e.stopPropagation(),e.preventDefault()}}),l.attach(s,"dragenter",function(e){!o()&&n(e)&&i.onEnter(e)}),l.attach(s,"dragleave",function(e){if(n(e)){i.onLeave(e);var t=document.elementFromPoint(e.clientX,e.clientY);qq(this).contains(t)||i.onLeaveNotDescendants(e)}}),l.attach(s,"drop",function(e){!o()&&n(e)&&(e.preventDefault(),i.onDrop(e))})}(),{dropDisabled:function(e){return o(e)},dispose:function(){l.dispose()}}},qq.FineUploader=function(e){qq.FineUploaderBasic.apply(this,arguments),qq.extend(this._options,{element:null,listElement:null,dragAndDrop:{extraDropzones:[],hideDropzones:!0,disableDefaultDropzone:!1},text:{uploadButton:"Upload a file",cancelButton:"Cancel",retryButton:"Retry",deleteButton:"Delete",failUpload:"Upload failed",dragZone:"Drop files here to upload",dropProcessing:"Processing dropped files...",formatProgress:"{percent}% of {total_size}",waitingForResponse:"Processing..."},template:'<div class="qq-uploader">'+(this._options.dragAndDrop&&this._options.dragAndDrop.disableDefaultDropzone?"":'<div class="qq-upload-drop-area"></div>')+(this._options.button?"":'<div class="qq-upload-button"><div>{uploadButtonText}</div></div>')+'<span class="qq-drop-processing"><span>{dropProcessingText}</span><span class="qq-drop-processing-spinner"></span></span>'+(this._options.listElement?"":'<ul class="qq-upload-list"></ul>')+"</div>",fileTemplate:'<li><div class="qq-progress-bar"></div><span class="qq-upload-spinner"></span><span class="qq-upload-finished"></span><span class="qq-upload-file"></span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">{cancelButtonText}</a><a class="qq-upload-retry" href="#">{retryButtonText}</a><a class="qq-upload-delete" href="#">{deleteButtonText}</a><span class="qq-upload-status-text">{statusText}</span></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"",list:"qq-upload-list",progressBar:"qq-progress-bar",file:"qq-upload-file",spinner:"qq-upload-spinner",finished:"qq-upload-finished",retrying:"qq-upload-retrying",retryable:"qq-upload-retryable",size:"qq-upload-size",cancel:"qq-upload-cancel",deleteButton:"qq-upload-delete",retry:"qq-upload-retry",statusText:"qq-upload-status-text",success:"qq-upload-success",fail:"qq-upload-fail",successIcon:null,failIcon:null,dropProcessing:"qq-drop-processing",dropProcessingSpinner:"qq-drop-processing-spinner"},failedUploadTextDisplay:{mode:"default",maxChars:50,responseProperty:"error",enableTooltip:!0},messages:{tooManyFilesError:"You may only drop one file",unsupportedBrowser:"Unrecoverable error - this browser does not permit file uploading of any kind."},retry:{showAutoRetryNote:!0,autoRetryNote:"Retrying {retryNum}/{maxAuto}...",showButton:!1},deleteFile:{forceConfirm:!1,confirmMessage:"Are you sure you want to delete {filename}?",deletingStatusText:"Deleting...",deletingFailedText:"Delete failed"},display:{fileSizeOnSubmit:!1},paste:{promptForName:!1,namePromptMessage:"Please name this image"},showMessage:function(e){setTimeout(function(){window.alert(e)},0)},showConfirm:function(e,t,n){setTimeout(function(){window.confirm(e)?t():n&&n()},0)},showPrompt:function(e,t){var n=new qq.Promise,o=window.prompt(e,t);return null!=o&&0<qq.trimStr(o).length?n.success(o):n.failure("Undefined or invalid user-supplied value."),n}},!0),qq.extend(this._options,e,!0),!qq.supportedFeatures.uploading||this._options.cors.expected&&!qq.supportedFeatures.uploadCors?this._options.element.innerHTML="<div>"+this._options.messages.unsupportedBrowser+"</div>":(this._wrapCallbacks(),this._options.template=this._options.template.replace(/\{dragZoneText\}/g,this._options.text.dragZone),this._options.template=this._options.template.replace(/\{uploadButtonText\}/g,this._options.text.uploadButton),this._options.template=this._options.template.replace(/\{dropProcessingText\}/g,this._options.text.dropProcessing),this._options.fileTemplate=this._options.fileTemplate.replace(/\{cancelButtonText\}/g,this._options.text.cancelButton),this._options.fileTemplate=this._options.fileTemplate.replace(/\{retryButtonText\}/g,this._options.text.retryButton),this._options.fileTemplate=this._options.fileTemplate.replace(/\{deleteButtonText\}/g,this._options.text.deleteButton),this._options.fileTemplate=this._options.fileTemplate.replace(/\{statusText\}/g,""),this._element=this._options.element,this._element.innerHTML=this._options.template,this._listElement=this._options.listElement||this._find(this._element,"list"),this._classes=this._options.classes,this._button||(this._button=this._createUploadButton(this._find(this._element,"button"))),this._bindCancelAndRetryEvents(),this._dnd=this._setupDragAndDrop(),this._options.paste.targetElement&&this._options.paste.promptForName&&this._setupPastePrompt())},qq.extend(qq.FineUploader.prototype,qq.FineUploaderBasic.prototype),qq.extend(qq.FineUploader.prototype,{clearStoredFiles:function(){qq.FineUploaderBasic.prototype.clearStoredFiles.apply(this,arguments),this._listElement.innerHTML=""},addExtraDropzone:function(e){this._dnd.setupExtraDropzone(e)},removeExtraDropzone:function(e){return this._dnd.removeDropzone(e)},getItemByFileId:function(e){for(var t=this._listElement.firstChild;t;){if(t.qqFileId==e)return t;t=t.nextSibling}},reset:function(){qq.FineUploaderBasic.prototype.reset.apply(this,arguments),this._element.innerHTML=this._options.template,this._listElement=this._options.listElement||this._find(this._element,"list"),this._options.button||(this._button=this._createUploadButton(this._find(this._element,"button"))),this._bindCancelAndRetryEvents(),this._dnd.dispose(),this._dnd=this._setupDragAndDrop()},_removeFileItem:function(e){e=this.getItemByFileId(e),qq(e).remove()},_setupDragAndDrop:function(){var e,t=this,n=this._find(this._element,"dropProcessing"),o=this._options.dragAndDrop.extraDropzones;return e=function(e){e.preventDefault()},this._options.dragAndDrop.disableDefaultDropzone||o.push(this._find(this._options.element,"drop")),new qq.DragAndDrop({dropZoneElements:o,hideDropZonesBeforeEnter:this._options.dragAndDrop.hideDropzones,allowMultipleItems:this._options.multiple,classes:{dropActive:this._options.classes.dropActive},callbacks:{processingDroppedFiles:function(){var o=t._button.getInput();qq(n).css({display:"block"}),qq(o).attach("click",e)},processingDroppedFilesComplete:function(o){var i=t._button.getInput();qq(n).hide(),qq(i).detach("click",e),o&&t.addFiles(o)},dropError:function(e,n){t._itemError(e,n)},dropLog:function(e,n){t.log(e,n)}}})},_leaving_document_out:function(e){return(qq.chrome()||qq.safari()&&qq.windows())&&0==e.clientX&&0==e.clientY||qq.firefox()&&!e.relatedTarget},_storeForLater:function(e){qq.FineUploaderBasic.prototype._storeForLater.apply(this,arguments);var t=this.getItemByFileId(e);qq(this._find(t,"spinner")).hide()},_find:function(e,t){var n=qq(e).getByClass(this._options.classes[t])[0];if(!n)throw Error("element not found "+t);return n},_onSubmit:function(e,t){qq.FineUploaderBasic.prototype._onSubmit.apply(this,arguments),this._addToList(e,t)},_onProgress:function(e,t,n,o){qq.FineUploaderBasic.prototype._onProgress.apply(this,arguments);var i,s,r,a;i=this.getItemByFileId(e),s=this._find(i,"progressBar"),r=Math.round(100*(n/o)),n===o?(a=this._find(i,"cancel"),qq(a).hide(),qq(s).hide(),qq(this._find(i,"statusText")).setText(this._options.text.waitingForResponse),this._displayFileSize(e)):(this._displayFileSize(e,n,o),qq(s).css({display:"block"})),qq(s).css({width:r+"%"})},_onComplete:function(e,t,n){qq.FineUploaderBasic.prototype._onComplete.apply(this,arguments);var o=this.getItemByFileId(e);qq(this._find(o,"statusText")).clearText(),qq(o).removeClass(this._classes.retrying),qq(this._find(o,"progressBar")).hide(),(!this._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading)&&qq(this._find(o,"cancel")).hide(),qq(this._find(o,"spinner")).hide(),n.success?(this._isDeletePossible()&&this._showDeleteLink(e),qq(o).addClass(this._classes.success),this._classes.successIcon&&(this._find(o,"finished").style.display="inline-block",qq(o).addClass(this._classes.successIcon))):(qq(o).addClass(this._classes.fail),this._classes.failIcon&&(this._find(o,"finished").style.display="inline-block",qq(o).addClass(this._classes.failIcon)),this._options.retry.showButton&&!this._preventRetries[e]&&qq(o).addClass(this._classes.retryable),this._controlFailureTextDisplay(o,n))},_onUpload:function(e){qq.FineUploaderBasic.prototype._onUpload.apply(this,arguments),this._showSpinner(e)},_onCancel:function(e){qq.FineUploaderBasic.prototype._onCancel.apply(this,arguments),this._removeFileItem(e)},_onBeforeAutoRetry:function(e){var t,n,o,i,s;qq.FineUploaderBasic.prototype._onBeforeAutoRetry.apply(this,arguments),t=this.getItemByFileId(e),n=this._find(t,"progressBar"),this._showCancelLink(t),n.style.width=0,qq(n).hide(),this._options.retry.showAutoRetryNote&&(n=this._find(t,"statusText"),o=this._autoRetries[e]+1,i=this._options.retry.maxAutoAttempts,s=this._options.retry.autoRetryNote.replace(/\{retryNum\}/g,o),s=s.replace(/\{maxAuto\}/g,i),qq(n).setText(s),1===o&&qq(t).addClass(this._classes.retrying))},_onBeforeManualRetry:function(e){var t=this.getItemByFileId(e);return qq.FineUploaderBasic.prototype._onBeforeManualRetry.apply(this,arguments)?(this._find(t,"progressBar").style.width=0,qq(t).removeClass(this._classes.fail),qq(this._find(t,"statusText")).clearText(),this._showSpinner(e),this._showCancelLink(t),!0):(qq(t).addClass(this._classes.retryable),!1)},_onSubmitDelete:function(e){return this._isDeletePossible()?void(!1!==this._options.callbacks.onSubmitDelete(e)&&(this._options.deleteFile.forceConfirm?this._showDeleteConfirm(e):this._sendDeleteRequest(e))):(this.log("Delete request ignored for file ID "+e+", delete feature is disabled.","warn"),!1)},_onDeleteComplete:function(e,t,n){qq.FineUploaderBasic.prototype._onDeleteComplete.apply(this,arguments);var o=this.getItemByFileId(e),i=this._find(o,"spinner"),o=this._find(o,"statusText");qq(i).hide(),n?(qq(o).setText(this._options.deleteFile.deletingFailedText),this._showDeleteLink(e)):this._removeFileItem(e)},_sendDeleteRequest:function(e){var t=this.getItemByFileId(e),n=this._find(t,"deleteButton"),t=this._find(t,"statusText");qq(n).hide(),this._showSpinner(e),qq(t).setText(this._options.deleteFile.deletingStatusText),this._deleteHandler.sendDelete(e,this.getUuid(e))},_showDeleteConfirm:function(e){var t=this._options.deleteFile.confirmMessage.replace(/\{filename\}/g,this._handler.getName(e));this.getUuid(e);var n=this;this._options.showConfirm(t,function(){n._sendDeleteRequest(e)})},_addToList:function(e,t){var n=qq.toElement(this._options.fileTemplate);if(this._options.disableCancelForFormUploads&&!qq.supportedFeatures.ajaxUploading){var o=this._find(n,"cancel");qq(o).remove()}n.qqFileId=e,o=this._find(n,"file"),qq(o).setText(this._options.formatFileName(t)),qq(this._find(n,"size")).hide(),this._options.multiple||(this._handler.cancelAll(),this._clearList()),this._listElement.appendChild(n),this._options.display.fileSizeOnSubmit&&qq.supportedFeatures.ajaxUploading&&this._displayFileSize(e)},_clearList:function(){this._listElement.innerHTML="",this.clearStoredFiles()},_displayFileSize:function(e,t,n){var o=this.getItemByFileId(e),e=this._formatSize(this.getSize(e)),o=this._find(o,"size");void 0!==t&&void 0!==n&&(e=this._formatProgress(t,n)),qq(o).css({display:"inline"}),qq(o).setText(e)},_bindCancelAndRetryEvents:function(){var e=this;this._disposeSupport.attach(this._listElement,"click",function(t){var t=t||window.event,n=t.target||t.srcElement;if(qq(n).hasClass(e._classes.cancel)||qq(n).hasClass(e._classes.retry)||qq(n).hasClass(e._classes.deleteButton)){for(qq.preventDefault(t),t=n.parentNode;void 0===t.qqFileId;)t=t.parentNode;qq(n).hasClass(e._classes.deleteButton)?e.deleteFile(t.qqFileId):qq(n).hasClass(e._classes.cancel)?e.cancel(t.qqFileId):(qq(t).removeClass(e._classes.retryable),e.retry(t.qqFileId))}})},_formatProgress:function(e,t){var n=this._options.text.formatProgress,o=Math.round(100*(e/t)),n=n.replace("{percent}",o),o=this._formatSize(t);return n=n.replace("{total_size}",o)},_controlFailureTextDisplay:function(e,t){var n,o,i,s;n=this._options.failedUploadTextDisplay.mode,o=this._options.failedUploadTextDisplay.maxChars,i=this._options.failedUploadTextDisplay.responseProperty,"custom"===n?((n=t[i])?n.length>o&&(s=n.substring(0,o)+"..."):(n=this._options.text.failUpload,this.log("'"+i+"' is not a valid property on the server response.","warn")),qq(this._find(e,"statusText")).setText(s||n),this._options.failedUploadTextDisplay.enableTooltip&&this._showTooltip(e,n)):"default"===n?qq(this._find(e,"statusText")).setText(this._options.text.failUpload):"none"!==n&&this.log("failedUploadTextDisplay.mode value of '"+n+"' is not valid","warn")},_showTooltip:function(e,t){e.title=t},_showSpinner:function(e){this._find(this.getItemByFileId(e),"spinner").style.display="inline-block"},_showCancelLink:function(e){(!this._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading)&&(e=this._find(e,"cancel"),qq(e).css({display:"inline"}))},_showDeleteLink:function(e){e=this._find(this.getItemByFileId(e),"deleteButton"),qq(e).css({display:"inline"})},_itemError:function(){this._options.showMessage(qq.FineUploaderBasic.prototype._itemError.apply(this,arguments))},_batchError:function(e){qq.FineUploaderBasic.prototype._batchError.apply(this,arguments),this._options.showMessage(e)},_setupPastePrompt:function(){var e=this;this._options.callbacks.onPasteReceived=function(){return e._options.showPrompt(e._options.paste.namePromptMessage,e._options.paste.defaultName)}}}),qq.AjaxRequestor=function(e){function t(e){var t=qq.indexOf(l,e),o=d.maxConnections;delete u[e],l.splice(t,1),l.length>=o&&o>t&&(e=l[o-1],n(e))}function n(e){var t,n=new XMLHttpRequest,l=s(),p={};d.onSend(e),d.paramsStore.getParams&&(p=d.paramsStore.getParams(e)),t=p;var c=d.endpointStore.getEndpoint(e),f=u[e].addToPath;void 0!==f&&(c+="/"+f),t=a&&t?qq.obj2url(t,c):c,u[e].xhr=n,n.onreadystatechange=o(e),n.open(l,t,!0),d.cors.expected&&d.cors.sendCredentials&&(n.withCredentials=!0),i(e),r("Sending "+l+" request for "+e),!a&&p?n.send(qq.obj2url(p,"")):n.send()}function o(e){var n=u[e].xhr;return function(){if(4===n.readyState){var o=u[e].xhr,i=s(),a=!1;t(e),0<=qq.indexOf(d.successfulResponseCodes,o.status)||(a=!0,r(i+" request for "+e+" has failed - response code "+o.status,"error")),d.onComplete(e,o,a)}}}function i(e){var t=u[e].xhr,e=d.customHeaders;t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Cache-Control","no-cache"),qq.each(e,function(e,n){t.setRequestHeader(e,n)})}function s(){return d.demoMode?"GET":d.method}var r,a,l=[],u=[],d={method:"POST",maxConnections:3,customHeaders:{},endpointStore:{},paramsStore:{},successfulResponseCodes:[200],demoMode:!1,cors:{expected:!1,sendCredentials:!1},log:function(){},onSend:function(){},onComplete:function(){},onCancel:function(){}};return qq.extend(d,e),r=d.log,a="GET"===s()||"DELETE"===s(),{send:function(e,t){u[e]={addToPath:t},l.push(e)<=d.maxConnections&&n(e)},cancel:function(e){var n=u[e].xhr,o=s();return n?(n.onreadystatechange=null,n.abort(),t(e),r("Cancelled "+o+" for "+e),d.onCancel(e),e=!0):e=!1,e}}},qq.DeleteFileAjaxRequestor=function(e){var t,n={endpointStore:{},maxConnections:3,customHeaders:{},paramsStore:{},demoMode:!1,cors:{expected:!1,sendCredentials:!1},log:function(){},onDelete:function(){},onDeleteComplete:function(){}};return qq.extend(n,e),t=new qq.AjaxRequestor({method:"DELETE",endpointStore:n.endpointStore,paramsStore:n.paramsStore,maxConnections:n.maxConnections,customHeaders:n.customHeaders,successfulResponseCodes:[200,202,204],demoMode:n.demoMode,log:n.log,onSend:n.onDelete,onComplete:n.onDeleteComplete}),{sendDelete:function(e,o){t.send(e,o),n.log("Submitted delete file request for "+e)}}},qq.WindowReceiveMessage=function(e){var t={};return qq.extend({log:function(){}},e),{receiveMessage:function(e,n){var o=function(e){n(e.data)};window.postMessage?t[e]=qq(window).attach("message",o):log("iframe message passing not supported in this browser!","error")},stopReceivingMessages:function(e){window.postMessage&&(e=t[e])&&e()}}},qq.UploadHandler=function(e){var t,n,o,i,s=[];return t={debug:!1,forceMultipart:!0,paramsInBody:!1,paramsStore:{},endpointStore:{},cors:{expected:!1,sendCredentials:!1},maxConnections:3,uuidParamName:"qquuid",totalFileSizeParamName:"qqtotalfilesize",chunking:{enabled:!1,partSize:2e6,paramNames:{partIndex:"qqpartindex",partByteOffset:"qqpartbyteoffset",chunkSize:"qqchunksize",totalParts:"qqtotalparts",filename:"qqfilename"}},resume:{enabled:!1,id:null,cookiesExpireIn:7,paramNames:{resuming:"qqresume"}},blobs:{paramNames:{name:"qqblobname"}},log:function(){},onProgress:function(){},onComplete:function(){},onCancel:function(){},onUpload:function(){},onUploadChunk:function(){},onAutoRetry:function(){},onResume:function(){}},qq.extend(t,e),n=t.log,o=function(e){var e=qq.indexOf(s,e),n=t.maxConnections;e>=0&&(s.splice(e,1),s.length>=n&&n>e&&(e=s[n-1],i.upload(e)))},i=qq.supportedFeatures.ajaxUploading?new qq.UploadHandlerXhr(t,o,n):new qq.UploadHandlerForm(t,o,n),{add:function(e){return i.add(e)},upload:function(e){return s.push(e)<=t.maxConnections?i.upload(e):void 0},retry:function(e){return 0<=qq.indexOf(s,e)?i.upload(e,!0):this.upload(e)},cancel:function(e){n("Cancelling "+e),t.paramsStore.remove(e),i.cancel(e),o(e)},cancelAll:function(){var e=this,t=[];qq.extend(t,s),qq.each(t,function(t,n){e.cancel(n)}),s=[]},getName:function(e){return i.getName(e)},getSize:function(e){return i.getSize?i.getSize(e):void 0},getFile:function(e){return i.getFile?i.getFile(e):void 0},getQueue:function(){return s},reset:function(){n("Resetting upload handler"),s=[],i.reset()},getUuid:function(e){return i.getUuid(e)},isValid:function(e){return i.isValid(e)},getResumableFilesData:function(){return i.getResumableFilesData?i.getResumableFilesData():[]}}},qq.UploadHandlerForm=function(e,t,n){function o(e){void 0!==c[e]&&(c[e](),delete c[e])}function i(e,t){var n=e.id;m[p[n]]=t,c[n]=qq(e).attach("load",function(){d[n]&&(h("Received iframe load event for CORS upload request (file id "+n+")"),f[n]=setTimeout(function(){var e="No valid message received from loaded iframe for file id "+n;h(e,"error"),t({error:e})},1e3))}),q.receiveMessage(n,function(e){h("Received the following window message: '"+e+"'");var t=qq.parseJson(e),i=t.uuid;i&&m[i]?(clearTimeout(f[n]),delete f[n],o(n),e=m[i],delete m[i],q.stopReceivingMessages(n),e(t)):i||h("'"+e+"' does not contain a UUID - ignoring.")})}function s(e,t){u.cors.expected?i(e,t):c[e.id]=qq(e).attach("load",function(){if(h("Received response for "+e.id),e.parentNode){try{if(e.contentDocument&&e.contentDocument.body&&"false"==e.contentDocument.body.innerHTML)return}catch(n){h("Error when attempting to access iframe during handling of upload response ("+n+")","error")}t()}})}function r(e){var t=qq.toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t}function a(e,t){var n=u.paramsStore.getParams(e),o=qq.toElement('<form method="'+(u.demoMode?"GET":"POST")+'" enctype="multipart/form-data"></form>'),i=u.endpointStore.getEndpoint(e),s=i;return n[u.uuidParamName]=p[e],u.paramsInBody?qq.obj2Inputs(n,o):s=qq.obj2url(n,i),o.setAttribute("action",s),o.setAttribute("target",t.name),o.style.display="none",document.body.appendChild(o),o}var l,u=e,d=[],p=[],c={},f={},h=n,q=new qq.WindowReceiveMessage({log:h}),m={};return l={add:function(e){e.setAttribute("name",u.inputName);var t=d.push(e)-1;return p[t]=qq.getUniqueId(),e.parentNode&&qq(e).remove(),t},getName:function(e){return l.isValid(e)?d[e].value.replace(/.*(\/|\\)/,""):void h(e+" is not a valid item ID.","error")},isValid:function(e){return void 0!==d[e]},reset:function(){d=[],p=[],c={}},getUuid:function(e){return p[e]},cancel:function(e){u.onCancel(e,this.getName(e)),delete d[e],delete p[e],delete c[e],u.cors.expected&&(clearTimeout(f[e]),delete f[e],q.stopReceivingMessages(e)),(e=document.getElementById(e))&&(e.setAttribute("src","java"+String.fromCharCode(115)+"cript:false;"),qq(e).remove())},upload:function(e){var n,i=d[e],p=l.getName(e),c=r(e);if(!i)throw Error("file with passed id was not added, or already uploaded or cancelled");return u.onUpload(e,this.getName(e)),n=a(e,c),n.appendChild(i),s(c,function(n){if(h("iframe loaded"),!n){var i;try{var s=c.contentDocument||c.contentWindow.document,r=s.body.innerHTML;h("converting iframe's innerHTML to JSON"),h("innerHTML = "+r),r&&r.match(/^<pre/i)&&(r=s.body.firstChild.firstChild.nodeValue),i=qq.parseJson(r)}catch(a){h("Error when attempting to parse form upload response ("+a+")","error"),i={success:!1}}n=i}o(e),u.cors.expected||qq(c).remove(),(n.success||!u.onAutoRetry(e,p,n))&&(u.onComplete(e,p,n),t(e))}),h("Sending upload request for "+e),n.submit(),qq(n).remove(),e}}},qq.UploadHandlerXhr=function(e,t,n){function o(e,t,n){var o=D.getSize(e),e=D.getName(e);t[v.chunking.paramNames.partIndex]=n.part,t[v.chunking.paramNames.partByteOffset]=n.start,t[v.chunking.paramNames.chunkSize]=n.size,t[v.chunking.paramNames.totalParts]=n.count,t[v.totalFileSizeParamName]=o,w&&(t[v.chunking.paramNames.filename]=e)}function i(e,t){var n,o=v.chunking.partSize,i=D.getSize(e),r=x[e].file||x[e].blobData.blob,a=o*t,o=a+o>=i?i:a+o,i=s(e);return r.slice?n=r.slice(a,o):r.mozSlice?n=r.mozSlice(a,o):r.webkitSlice&&(n=r.webkitSlice(a,o)),{part:t,start:a,end:o,count:i,blob:n,size:o-a}}function s(e){return e=D.getSize(e),Math.ceil(e/v.chunking.partSize)}function r(e){var t=new XMLHttpRequest;return x[e].xhr=t}function a(e,t,n,o){var i=new FormData,s=v.demoMode?"GET":"POST",r=v.endpointStore.getEndpoint(o),a=r,l=D.getName(o),u=D.getSize(o),d=x[o].blobData;return e[v.uuidParamName]=x[o].uuid,w&&(e[v.totalFileSizeParamName]=u,d&&(e[v.blobs.paramNames.name]=d.name)),v.paramsInBody||(w||(e[v.inputName]=l),a=qq.obj2url(e,r)),t.open(s,a,!0),v.cors.expected&&v.cors.sendCredentials&&(t.withCredentials=!0),w?(v.paramsInBody&&qq.obj2FormData(e,i),i.append(v.inputName,n),i):n}function l(e,t){var n=v.customHeaders,o=x[e].file||x[e].blobData.blob;t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Cache-Control","no-cache"),w||(t.setRequestHeader("Content-Type","application/octet-stream"),t.setRequestHeader("X-Mime-Type",o.type)),qq.each(n,function(e,n){t.setRequestHeader(e,n)})}function u(e,t,n){var o=D.getName(e),i=D.getSize(e);x[e].attemptingResume=!1,v.onProgress(e,o,i,i),v.onComplete(e,o,t,n),delete x[e].xhr,b(e)}function d(e){var t,n=x[e].remainingChunkIdxs[0],s=i(e,n),u=r(e),d=D.getSize(e),p=D.getName(e);void 0===x[e].loaded&&(x[e].loaded=0),C&&x[e].file&&h(e,s),u.onreadystatechange=f(e,u),u.upload.onprogress=function(t){if(t.lengthComputable){var o=t.loaded+x[e].loaded,t=t.total,s=i(e,n),t=t-s.size,r=D.getSize(e),s=s.count,a=t-x[e].initialRequestOverhead;x[e].lastRequestOverhead=t,0===n?(x[e].lastChunkIdxProgress=0,x[e].initialRequestOverhead=t,x[e].estTotalRequestsSize=r+s*t):x[e].lastChunkIdxProgress!==n&&(x[e].lastChunkIdxProgress=n,x[e].estTotalRequestsSize=x[e].estTotalRequestsSize+a),v.onProgress(e,p,o,x[e].estTotalRequestsSize)}},v.onUploadChunk(e,p,c(s)),t=v.paramsStore.getParams(e),o(e,t,s),x[e].attemptingResume&&(t[v.resume.paramNames.resuming]=!0),t=a(t,u,s.blob,e),l(e,u),y("Sending chunked upload request for item "+e+": bytes "+(s.start+1)+"-"+s.end+" of "+d),u.send(t)}function p(e){y("Server has ordered chunking effort to be restarted on next attempt for item ID "+e,"error"),C&&(q(e),x[e].attemptingResume=!1),x[e].remainingChunkIdxs=[],delete x[e].loaded,delete x[e].estTotalRequestsSize,delete x[e].initialRequestOverhead}function c(e){return{partIndex:e.part,startByte:e.start+1,endByte:e.end,totalParts:e.count}}function f(e,t){return function(){if(4===t.readyState){var n;if(x[e]){y("xhr - server response received for "+e),y("responseText = "+t.responseText);try{n=qq.parseJson(t.responseText)}catch(o){y("Error when attempting to parse xhr response text ("+o+")","error"),n={}}if(200!==t.status||!n.success||n.reset)if(n.reset&&p(e),x[e].attemptingResume&&n.reset)x[e].attemptingResume=!1,y("Server has declared that it cannot handle resume for item ID "+e+" - starting from the first chunk","error"),p(e),D.upload(e,!0);else{var s=D.getName(e);v.onAutoRetry(e,s,n,t)||u(e,n,t)}else if(S){var s=x[e].remainingChunkIdxs.shift(),r=i(e,s);x[e].attemptingResume=!1;var a,s=x[e],l=s.loaded,r=r.size;a=w?x[e].lastRequestOverhead:0,s.loaded=l+(r+a),0<x[e].remainingChunkIdxs.length?d(e):(C&&q(e),u(e,n,t))}else u(e,n,t)}}}}function h(e,t){var n=D.getUuid(e),o=x[e].loaded,i=x[e].initialRequestOverhead,s=x[e].estTotalRequestsSize,r=m(e);qq.setCookie(r,n+F+t.part+F+o+F+i+F+s,v.resume.cookiesExpireIn)}function q(e){x[e].file&&(e=m(e),qq.deleteCookie(e))}function m(e){var t=D.getName(e),e=D.getSize(e),n=v.chunking.partSize,t="qqfilechunk"+F+encodeURIComponent(t)+F+e+F+n;return void 0!==_&&(t+=F+_),t}function g(e){var t,n,o=x[e].file||x[e].blobData.blob,i=D.getName(e);x[e].loaded=0,t=r(e),t.upload.onprogress=function(t){t.lengthComputable&&(x[e].loaded=t.loaded,v.onProgress(e,i,t.loaded,t.total))},t.onreadystatechange=f(e,t),n=v.paramsStore.getParams(e),o=a(n,t,o,e),l(e,t),y("Sending upload request for "+e),t.send(o)}var _,v=e,b=t,y=n,x=[],F="|",S=v.chunking.enabled&&qq.supportedFeatures.chunking,C=v.resume.enabled&&S&&qq.supportedFeatures.resume;_=null===v.resume.id||void 0===v.resume.id||qq.isFunction(v.resume.id)||qq.isObject(v.resume.id)?void 0:v.resume.id;var D,w=v.forceMultipart||v.paramsInBody;return D={add:function(e){if(e instanceof File)e=x.push({file:e})-1;else{if(!qq.isBlob(e.blob))throw Error("Passed obj in not a File or BlobData (in qq.UploadHandlerXhr)");e=x.push({blobData:e})-1}return x[e].uuid=qq.getUniqueId(),e},getName:function(e){if(D.isValid(e)){var t=x[e].file,e=x[e].blobData;return t?null!==t.fileName&&void 0!==t.fileName?t.fileName:t.name:e.name}y(e+" is not a valid item ID.","error")},getSize:function(e){return e=x[e].file||x[e].blobData.blob,qq.isFileOrInput(e)&&null!=e.fileSize?e.fileSize:e.size},getFile:function(e){return x[e]?x[e].file||x[e].blobData.blob:void 0},getLoaded:function(e){return x[e].loaded||0},isValid:function(e){return void 0!==x[e]},reset:function(){x=[]},getUuid:function(e){return x[e].uuid},upload:function(e,t){var n=this.getName(e);if(v.onUpload(e,n),S){var o,r,a=D.getName(e),n=0;if(!x[e].remainingChunkIdxs||0===x[e].remainingChunkIdxs.length){if(x[e].remainingChunkIdxs=[],C&&!t&&x[e].file){e:{o=qq.getCookie(m(e)),r=D.getName(e);var l,u,p;if(o){if(o=o.split(F),5===o.length){r=o[0],l=parseInt(o[1],10),u=parseInt(o[2],10),p=parseInt(o[3],10),o=parseInt(o[4],10),o={uuid:r,part:l,lastByteSent:u,initialRequestOverhead:p,estTotalRequestsSize:o};break e}y("Ignoring previously stored resume/chunk cookie for "+r+" - old cookie format","warn")}o=void 0}o&&(r=i(e,o.part),!1!==v.onResume(e,a,c(r))&&(n=o.part,x[e].uuid=o.uuid,x[e].loaded=o.lastByteSent,x[e].estTotalRequestsSize=o.estTotalRequestsSize,x[e].initialRequestOverhead=o.initialRequestOverhead,x[e].attemptingResume=!0,y("Resuming "+a+" at partition index "+n)))}for(a=s(e)-1;a>=n;a-=1)x[e].remainingChunkIdxs.unshift(a)}d(e)}else g(e)},cancel:function(e){var t=x[e].xhr;v.onCancel(e,this.getName(e)),t&&(t.onreadystatechange=null,t.abort()),C&&q(e),delete x[e]},getResumableFilesData:function(){var e=[],t=[];return S&&C?(e=qq.getCookieNames(void 0===_?RegExp("^qqfilechunk\\"+F+".+\\"+F+"\\d+\\"+F+v.chunking.partSize+"="):RegExp("^qqfilechunk\\"+F+".+\\"+F+"\\d+\\"+F+v.chunking.partSize+"\\"+F+_+"=")),qq.each(e,function(e,n){var o=n.split(F),i=qq.getCookie(n).split(F);t.push({name:decodeURIComponent(o[1]),size:o[2],uuid:i[0],partIdx:i[1]})}),t):[]}}},function(e){var t,n,o,i,s,r,a,l,u,d;r=["uploaderType"],o=function(e){return e&&(e=l(e),a(e),t("basic"===s("uploaderType")?new qq.FineUploaderBasic(e):new qq.FineUploader(e))),n},i=function(e,t){var o=n.data("fineuploader");return t?(void 0===o&&(o={}),o[e]=t,n.data("fineuploader",o),void 0):void 0===o?null:o[e]},t=function(e){return i("uploader",e)},s=function(e,t){return i(e,t)},a=function(t){var o=t.callbacks={},t=new qq.FineUploaderBasic;e.each(t._options.callbacks,function(e){var t,i;t=/^on(\w+)/.exec(e)[1],t=t.substring(0,1).toLowerCase()+t.substring(1),i=n,o[e]=function(){var e=Array.prototype.slice.call(arguments);return i.triggerHandler(t,e)}})},l=function(t,o){var i,a;return i=void 0===o?"basic"!==t.uploaderType?{element:n[0]}:{}:o,e.each(t,function(t,n){0<=e.inArray(t,r)?s(t,n):n instanceof e?i[t]=n[0]:e.isPlainObject(n)?(i[t]={},l(n,i[t])):e.isArray(n)?(a=[],e.each(n,function(t,n){n instanceof e?e.merge(a,n):a.push(n)}),i[t]=a):i[t]=n}),void 0===o?i:void 0},u=function(n){return"string"===e.type(n)&&!n.match(/^_/)&&void 0!==t()[n]},d=function(e){var n=[],o=Array.prototype.slice.call(arguments,1);return l(o,n),t()[e].apply(t(),n)},e.fn.fineUploader=function(i){var s=this,r=arguments,a=[];return this.each(function(l,p){if(n=e(p),t()&&u(i)){if(a.push(d.apply(s,r)),1===s.length)return!1}else"object"!=typeof i&&i?e.error("Method "+i+" does not exist on jQuery.fineUploader"):o.apply(s,r)}),1===a.length?a[0]:1<a.length?a:this}}(jQuery),function(e){function t(e){return e||(e={}),e.dropZoneElements=[r],e=i(e),o(e),n(new qq.DragAndDrop(e)),r}function n(e){var t,n=r.data(a);return e?(void 0===n&&(n={}),n.dndInstance=e,r.data(a,n)):t=void 0===n?null:n.dndInstance,t}function o(t){var n=t.callbacks={};new qq.FineUploaderBasic,e.each(new qq.DragAndDrop.callbacks,function(e){var t;t=r,n[e]=function(){var n=Array.prototype.slice.call(arguments);return t.triggerHandler(e,n)}})}function i(t,n){var o,s;return o=void 0===n?{}:n,e.each(t,function(t,n){n instanceof e?o[t]=n[0]:e.isPlainObject(n)?(o[t]={},i(n,o[t])):e.isArray(n)?(s=[],e.each(n,function(t,n){n instanceof e?e.merge(s,n):s.push(n)}),o[t]=s):o[t]=n}),void 0===n?o:void 0}function s(e){var t=[],o=Array.prototype.slice.call(arguments,1);return i(o,t),n()[e].apply(n(),t)}var r,a="fineUploaderDnd";e.fn.fineUploaderDnd=function(o){var i=this,a=arguments,l=[];return this.each(function(u,d){if(r=e(d),n()&&"string"===e.type(o)&&"dispose"===o&&void 0!==n()[o]){if(l.push(s.apply(i,a)),1===i.length)return!1}else"object"!=typeof o&&o?e.error("Method "+o+" does not exist in Fine Uploader's DnD module."):t.apply(i,a)}),1===l.length?l[0]:1<l.length?l:this}}(jQuery);;function createGenerator(generator,server)
{$('#preloader').show();$.ajax({type:'post',url:'/generator/'+generator+'/create/'+server,data:$('#form-create').serialize(),dataType:'json',success:function(response){if((server=='comment')||(server=='mix')){addGeneratorPhoto(response);}
else{updateGeneratorContent(response);}},complete:function(response){$('#preloader').hide();}});return false;}
function updateGeneratorContent(response)
{if(response.type=='5'){$('.generator-content').html(response.message);}else{showMessage(response.message,'','error');generator_trim_fields()}}
function addGeneratorPhoto(response)
{if(response.type=='5'&&response.message.gallery_link&&response.message.img_id&&response.message.form_id)
{var $form=$(response.message.form_id);$form=$form.length?$form:$('form.form-save-comment-tag.comments-form[data-id="'+response.message.form_id+'"]');$form.find('.tipsy-w').css({'visibility':'hidden'});var $block=$form.find('.attaches');var preview_size=160;var size=fishki.utils.resizeCenter(response.message.gallery_pw,response.message.gallery_ph,preview_size);$block.append($('<div class="image-preview  reply-attached" id="image-preview-'+response.message.img_id+'" style="width: '+preview_size+'px; height: '+preview_size+'px; overflow: hidden;"><input type="hidden" name="attach[]" value="'+response.message.gallery_link+'">'+'<img src="'+response.message.gallery_preview+'" width="'+size.width+'" height="'+size.height+'" style="margin-left: '+size.marginLeft+'px; margin-top: '+size.marginTop+'px"/><div class="delete-preview close" onclick="$(this).parents(\'.image-preview\').remove();">&times;</div></div>'));hideWindow();}else{showMessage(response.message,'','error');generator_trim_fields()}}
function generator_trim_fields(){var generator_fields=['#first_line','#second_line','#top_text','#bottom_text'];for(var i=0;i<generator_fields.length;i++){if($(generator_fields[i]).val()){$(generator_fields[i]).val($(generator_fields[i]).val().trim());}}};$.fn.jamCommentForm=function(options){var settings={useLocalStorage:true,mobile:false,is_mix_mode:false,is_answer:false,is_new:false,is_edit:false,force:false};if(options)$.extend(settings,options);if(settings.useLocalStorage)
settings.useLocalStorage=(window.localStorage!==undefined);if(!window.jamCommentForm)
window.jamCommentForm={};if(!window.jamCommentForm.initIds)
window.jamCommentForm.initIds={};function init(){window.jamCommentForm.inited=true;}
if(!window.jamCommentForm.inited)
init();this.each(function(){var context=this;if(context.tagName.toLowerCase()!='form')
{console.log('Element is not form',context)
return;}
var id=$(this).attr('id');var action_url=$(this).attr('action')+"_"+id;var form_id=$(this).data('id');var form_real_id=$(this).attr('id');if(!form_id)
{console.log('Element has no ID',context)
return;}
if(id.indexOf("form_reply_comment")<0){if(!settings.force&&window.jamCommentForm.initIds[action_url]){console.log('repeated ID',action_url)
return;}
window.jamCommentForm.initIds[action_url]=true;}
var $context=$(context);var post_gal_id=form_id.split('_');if(post_gal_id[0]=='0'){var form_action=$context.attr('action');var match_action=form_action?form_action.match(/comment\/(save_post|save)\/(\d+)\/(\d+)/i):false;if(match_action){if(match_action[1]=='save_post'){if(match_action[3]==20)post_gal_id[0]='anekdot';else if(match_action[3]==34)post_gal_id[0]='mix';else if(match_action[3]==42)post_gal_id[0]='kartinka-dnja';else if(match_action[3]==43)post_gal_id[0]='linkmix';}
else
post_gal_id[0]=match_action[2];}}
$context.data('post_id',post_gal_id[0]);$context.data('gallery_id',post_gal_id[1]);var reply_to_comment=0;var def_comm_id=form_real_id?form_real_id.match(/form_reply_comment(\d+)/i):false;if(def_comm_id&&def_comm_id[1])
reply_to_comment=def_comm_id[1];$context.data('reply_to_comment',reply_to_comment);delete post_gal_id,def_comm_id,reply_to_comment;$context.getInitText=function(){var value=false;var post_id=$context.data('post_id');var gallery_id=$context.data('gallery_id');var reply_to=$context.data('reply_to_comment');var savedComments=settings.useLocalStorage&&window.localStorage['savedComments']?JSON.parse(window.localStorage['savedComments']):{};var key=[post_id,gallery_id,reply_to,fishki.params.my_user_id].join('_');if(typeof savedComments[key]=='string')
value=savedComments[key];return value;};$context.setInitText=function(value){if(fishki.params.my_user_id){var post_id=$context.data('post_id');var gallery_id=$context.data('gallery_id');var reply_to=$context.data('reply_to_comment');var savedComments=settings.useLocalStorage&&window.localStorage['savedComments']?JSON.parse(window.localStorage['savedComments']):{};var key=post_id+'_'+gallery_id+'_'+reply_to+'_'+fishki.params.my_user_id;if(value){savedComments[key]=value;window.localStorage['lastEditedComment']=key;}
else{delete window.localStorage['lastEditedComment'];if(typeof savedComments[key]!='undefined')
delete savedComments[key];}
window.localStorage['savedComments']=JSON.stringify(savedComments);}};if(settings.useLocalStorage)
{$(window).on('unload',$context.unload);$textarea=$context.find('textarea');$textarea.on('change input',function(e){$context.setInitText(this.value);});if(window.localStorage['savedComments']&&!options.is_edit){var initCommentText=$context.getInitText();if(initCommentText){var currCommentText=$textarea.val();if(currCommentText)
$textarea.val(initCommentText+"\n"+currCommentText);else
$textarea.val(initCommentText);}}
if(window.localStorage[form_id+'_attach'])
$context.find('.attach').empty().html(window.localStorage[form_id+'_attach']);}
$context.unload=function(){var s_text=$context.find('textarea').val(),$s_attach=$context.find('.attach');if($s_attach.find('div').length>0)
window.localStorage[form_id+'_attach']=$s_attach.html();else
window.localStorage.removeItem(form_id+'_attach');}
$context.clearStorage=function()
{if(settings.useLocalStorage)
{window.localStorage.removeItem(form_id+'_attach');}}
$context.clear=function(){$context.find('.picture-preview, .reply-attached').remove();$context.find('textarea').val('');$context.hideBlocks();$context.clearStorage();}
$context.hideBlocks=function()
{$context.find('.add-blocks').hide();$('.smile-block').css('display','none');}
$context.hideReplyForm=function()
{if($('.new_mobile_diz').length>0){$context.closest('.comment-upload').remove();}
if($context.hasClass('comment-reply-form')){if(settings.is_new){$context.closest('.comment-upload').remove();}
else{$context.parent().remove();}}
$('.comments .comment').removeClass('answered');}
$context.linkDownload=function(url,params){if(!params){params={}}
url=$.trim(url);if((url=='http://')||(url==''))
return false;url=encodeURIComponent(url);var is_post_add=$context.hasClass('comment-post');var endpoint=is_post_add?'/comment/download_post/':'/comment/download/0/';if(params.endpointDownloadOriginal){endpoint+='orig/';}
console.log('Download',params);$.ajax({type:'post',url:endpoint,data:'code='+url,dataType:'json',success:function(response){$block=$context.find('.attaches');if($block.find('.reply-attached.loading').length>0){$($block.find('.reply-attached.loading')[0]).remove();}
if(response.success==true){var preview_size_x=200;var preview_size_y=200;var input_name='attach';var value=response.gallery_link;var hash_src=typeof(response.hash_src)!='undefined'?response.hash_src:'';var duration=typeof(response.duration)!='undefined'?response.duration:0;if(response.video){input_name='attach_video';value=response.video_url;preview_size_x=200;}
if(response.embed){input_name='attach_embed';if(response.embeded_type=='twitter'){preview_size_x=500;}else{preview_size_x=615;}
var block='<div class="image-preview reply-attached type_'+input_name+'" id="image-preview-'+response.img_id+'" style="width: '+preview_size_x+'px; overflow: hidden;">'+'<input type="hidden" class="hash_src" value="'+hash_src+'"/>'+'<input type="hidden" name="duration['+value+']" value="'+duration+'"/>'+'<input type="hidden" name="'+input_name+'[]" value="'+value+'"/>'+response.embed+'<a href="javascript: void 0" class="close" onclick="removeImageFromEdit(this);">&times;</a>'+'</div>';}else{var width,height,targetWidth,src;if(params.endpointDownloadOriginal){width=response.gallery_w;height=response.gallery_h;targetWidth=preview_size_y*response.gallery_w/response.gallery_h;src=response.gallery_link;}else{width=response.gallery_sw;height=response.gallery_sh;targetWidth=preview_size_x;src=response.gallery_small_preview;}
src=(src.indexOf("http")<0&&fishki&&fishki.params&&fishki.params.static_host?fishki.params.static_host:'')+src;var size=fishki.utils.resizeCenter(width,height,targetWidth,preview_size_y);var className='image-preview reply-attached type_'+input_name;var block='<div class="'+className+'" id="image-preview-'+response.img_id+'" style="width: '+size.width+'px; height: '+size.height+'px; overflow: hidden;">';if(input_name=='attach_video')
block+='<div class="video_holder">';block+='<input type="hidden" name="'+input_name+'[]" value="'+value+'"/>'+'<input type="hidden" name="duration['+value+']" value="'+duration+'"/>'+'<input type="hidden" class="hash_src" name="hash_src['+response.img_id+']" value="'+hash_src+'"/>'+'<input type="hidden" class="original" value="'+(response.original?response.original:'')+'"/>'+'<img src="'+src+'" width="'+size.width+'" height="'+size.height+'" style="margin-left: '+size.marginLeft+'px; margin-top: '+size.marginTop+'px" />'+'<a href="javascript: void 0" class="close" onclick="removeImageFromEdit(this);">&times;</a>'+
(response.is_image&&!params.endpointDownloadOriginal?'<a href="javascript: void 0" class="rotate"></a>':'');if(input_name=='attach_video')
block+='</div>';block+='</div>';}
if(!response.embed){if($('.image-preview:not(.type_attach_embed)',$block).length>0){$insertedBlock=$(block).insertAfter($('.image-preview:not(.type_attach_embed)',$block).last());}else{$insertedBlock=$(block).prependTo($block);}}else{$insertedBlock=$(block).appendTo($block);}
$insertedBlock.find('.rotate').click(function(e){$context.rotateImage(e.target);});$context.checkConfirm(response);if(response.embed){if(response.embeded_type=='twitter'){try{twttr.widgets.load();}catch(e){}}
if(response.embeded_type=='instagram'){try{instgrm.Embeds.process();}catch(e){}}}}
else{if(response.message)
showMessage(response.message,'','error');else if(url.indexOf('tvigle.ru')!=-1||url.indexOf('tvigle.ru')!=-1)
showMessage('Данное видео не может быть добавлено','','error');}
$context.find('.photo-add .url, input.embed-add, input.video-add, textarea.video-add').removeClass('process');}});}
$context.showGeneratorForm=function(category){return showGeneratorForm(category,{is_out_wall:$context.hasClass('comment-post')?1:0,is_comment:1,form_id:form_id,form_real_id:form_real_id});}
$context.checkSocialRepost=function(comment_id,link){link=link?link:$context.data('link');if(!link)
return false;comment_id=comment_id||false;var params={'message':stripSmiles($context.find('textarea[name="comment"]').val()),'link':(link.substr(0,2)=='//'?'https:':'')+link};if(comment_id)
params.link+='/comment-'+comment_id+'/?from=social';var vk=$context.find('[name=vk_comment].checked').length||$context.find('input[type=checkbox][name=2vk]:checked').length;if(vk){vkfeedPostMessage(params)}}
$context.clearConfirm=function()
{var confirm_attr='confirm=true';var action=$context.attr('action');if(action.indexOf(confirm_attr)>0)
{action.replace('&'+confirm_attr,'');action.replace('?'+confirm_attr,'');}}
$context.checkConfirm=function(responseJSON)
{var confirm_attr='confirm=true';var is_post_add=$context.hasClass('comment-post');var action=$context.attr('action');if(responseJSON&&responseJSON.confirm&&responseJSON.confirm.need_confirm&&is_post_add&&(action.indexOf(confirm_attr)<0))
{var delim=action.indexOf('?')<0?'?':'&';$context.attr('action',action+delim+confirm_attr);if(responseJSON.confirm.html&&$context.find('.confirm-html').length)
{if(responseJSON.confirm.message)
showMessage(responseJSON.confirm.message,'','error');$context.find('.confirm-html').html(responseJSON.confirm.html);}
return true;}
return false;}
$context.submitHandler=function(){$('.tipsy-w').css({'visibility':'hidden'});$context.hideBlocks();$block=$context.find('.attaches');if($('.image-preview:not(.type_attach_embed)',$block).length>0){var $delete=$block.find('.image-preview.delete');if($delete.length===1){$('<div class="reply-attached loading"></div>').replaceAll($delete);}
else{$('<div class="reply-attached loading"></div>').insertAfter($('.image-preview:not(.type_attach_embed)',$block).last());}}else{$block.prepend($('<div class="reply-attached loading"></div>'));}
$context.addClass('disable_comment_file');};$context.completeHandler=function(event,id,fileName,responseJSON){$context.removeClass('disable_comment_file');$block=$context.find('.attaches');$context.checkConfirm(responseJSON);if(responseJSON.gallery_link&&responseJSON.img_id&&!responseJSON.error)
{var preview_width=200;var preview_height=200;var size=fishki.utils.resizeCenter(responseJSON.gallery_sw,responseJSON.gallery_sh,preview_width);if(responseJSON.no_resize){preview_width=responseJSON.gallery_sw;preview_height=responseJSON.gallery_sh;size={width:responseJSON.gallery_sw,height:responseJSON.gallery_sh,marginLeft:0,marginTop:0};}
var hash_src=typeof(responseJSON.hash_src)!='undefined'?responseJSON.hash_src:'';var duration=typeof(responseJSON.duration)!='undefined'?responseJSON.duration:0;var src=responseJSON.gallery_small_preview;src=(src.indexOf("http")<0&&fishki&&fishki.params&&fishki.params.static_host?fishki.params.static_host:'')+src;var block='<div class="image-preview reply-attached" id="image-preview-'+responseJSON.img_id+'" style="width: '+preview_width+'px; height: '+preview_height+'px; overflow: hidden;">'+'<input type="hidden" name="attach[]" value="'+responseJSON.gallery_link+'"/>'+'<input type="hidden" name="duration['+responseJSON.gallery_link+']" value="'+duration+'"/>'+'<input type="hidden" class="hash_src" name="hash_src['+responseJSON.img_id+']" value="'+hash_src+'"/>'+'<input type="hidden" class="original" value="'+(responseJSON.original?responseJSON.original:'')+'"/>'+'<img src="'+src+'" width="'+size.width+'" height="'+size.height+'" style="margin-left: '+size.marginLeft+'px; margin-top: '+size.marginTop+'px" />'+'<a href="javascript: void 0" class="close" onclick="removeImageFromEdit(this);">&times;</a>'+
(responseJSON.type==='image'?'<a href="javascript: void 0" class="rotate"></a>':'')+'</div>';$loading=$block.find('.reply-attached.loading');if($loading.length>0){$insertedBlock=$(block).replaceAll($loading[0]);}else{$insertedBlock=$(block).prependTo($block);}
$insertedBlock.find('.rotate').click(function(e){$context.rotateImage(e.target);});}
else
{console.log(responseJSON);if(responseJSON.error)
showMessage(responseJSON.error,'','error');}};$context.rotateImage=function($this)
{var form=$($this).closest('.comments-form');var image=$($this).parents('.image-preview');var original=image.find('.original').val();$.ajax({method:"post",url:"/comment/rotateImage/",dataType:"json",data:{"original":original},beforeSend:function(xhr){image.addClass('delete');$context.submitHandler();}}).done(function(data){$context.completeHandler(null,null,null,data);}).fail(function(){showMessage(data.message,'Ошибка','error');});}
$context.init=function()
{var $self=this;var is_post_add=$context.hasClass('comment-post');var skip_watermark=$context.hasClass('skip-watermark');$self.find("textarea").keydown(function(e){if((e.ctrlKey||e.metaKey)&&(e.keyCode==13))
{$context.submit();}});var endpoint=is_post_add?'/comment/upload_post/':'/comment/upload/';var params=[]
if(skip_watermark){params.push('skip_watermark=1');}
if(params.length){endpoint+='?'+params.join('&');}
var fineuploader_settings={request:{endpoint:endpoint,},listElement:null,text:{uploadButton:settings.mobile?' ':((fishki&&fishki.params&&fishki.params.profile_user_id)?getTranslatedString('Загрузить'):getTranslatedString('Загрузите с диска')),dropProcessing:' ',dragZone:' '},multiple:false,showMessage:function(message){showMessage(message,'','error',10000);},messages:{sizeError:'{file} очень большой, максимальный размер файла {sizeLimit}',typeError:'{file} тип файла не поддерживается. Список поддерживаемых расширений: {extensions}',}};var sel_file_dialog=settings.mobile?'.icon-input-photo-add':'.open-file-dialog';var $qq=$context.find(sel_file_dialog).fineUploader($.extend(true,{request:{params:{fileType:'image'},},validation:{sizeLimit:10*1024*1024,allowedExtensions:['gif','jpg','jpeg','png','webp'],image:{minHeight:50,minWidth:50,maxHeight:2000,maxWidth:2000,}}},fineuploader_settings)).on("submit",$context.submitHandler).on("complete",$context.completeHandler);if(fishki&&fishki.imagePaste){fishki.imagePaste.register($context.find('.comment-textarea').get(0),{convertTo:'file',},function(target,file){$qq.fineUploader('addFiles',file);});}
$context.find('.icon-input-mp3-add').fineUploader($.extend(true,{request:{params:{fileType:'mp3'},},validation:{sizeLimit:10*1024*1024,allowedExtensions:['mp3'],}},fineuploader_settings)).on("submit",$context.submitHandler).on("complete",$context.completeHandler);$context.find('.mp4-file-dialog').fineUploader($.extend(true,{request:{params:{fileType:'mp4'},},validation:{sizeLimit:50*1024*1024,allowedExtensions:['mp4'],}},fineuploader_settings)).on("submit",$context.submitHandler).on("complete",$context.completeHandler);var input_files=[];$self.ajaxForm({beforeSubmit:function(arr,$form,options){if($form.hasClass('comment-edit-form')&&prevent_hash_edit!=undefined){var textarea=$form.find('textarea.comment-textarea');var text=textarea.val();for(var index in prevent_hash_edit){if(prevent_hash_edit.hasOwnProperty(index)){var attach=$form.find('.image-preview input.hash_src[value="'+index+'"]');attach.closest('.image-preview').remove();$.each(arr,function(i,v){if(v!=undefined&&v.value==prevent_hash_edit[index].link&&$.inArray(v.name,["attach[]","attach_video[]","attach_embed[]"])>=0){arr.splice(i,1);return false;}});}}}
$form.find('.reply-wrap').addClass('progress_comment_form');$form.append('<div class="preloader"></div>')
$form.find('input[type=submit]').attr('disabled','disabled');$form.find('.qq-upload-button').each(function(i,element){var $this=$(this);input_files[i]=$this.find('input[type="file"]').remove();});$input_file=$form.find('input[type="file"]').remove();if(is_post_add&&$form.find('.confirm-html').length)
$form.find('.confirm-html').html('');if($form.parents('.top-comment').find('.answers-skip').length){arr.push({name:'answers_skip',value:$form.parents('.top-comment').find('.answers-skip').data('href')});}
if($form.parents('.top-comment').find('.remove_answer_when_loading').length){arr.push({name:'answers_more',value:$form.parents('.top-comment').find('.answers-more').data('href')});}
if(typeof $form.parents('.idcomments-main').data('list-gallery-id')!='undefined'){arr.push({name:'list_gallery_id',value:$form.parents('.idcomments-main').data('list-gallery-id')});}},success:function(data,status,xhr,$form){$('.by_count_comments_hidden').show();var wrapdiv=$($form.closest('.wrap-comments'));var c_selector=$('.modal--gallery--comment').length?$('.modal--gallery--comment'):wrapdiv;c_selector.find('#button-load-more-comments').hide();$form.find('.reply-wrap').removeClass('progress_comment_form');$form.find('.preloader').remove();var confirm_attr='confirm=true';$form.find('input[type=submit]').removeAttr('disabled');wrapdiv.find('.comments-form-button').filter('.comment-photo .comments-form-button').slideUp();var $upload_button=$form.find('.qq-upload-button');for(var i=0;i<input_files.length;i++){$($upload_button[i]).append(input_files[i]);}
try{data=jQuery.parseJSON(data);}catch(e){}
if(data.category&&data.category=='linkmix'){$context.addClass('comment-post');is_post_add=true;}
if(is_post_add&&$context.checkConfirm(data))
return;if(data.update_comment_id){update_comment(data);return;}
if(data.captcha){check_captcha(function(){$context.submit();$context.clear();$context.setInitText('');},'comment');}else if(data.message){showMessage(data.message,getTranslatedString('Ошибка добавления комментария'),'error');}else{if(data.successMessage){showMessage(data.successMessage,'','success');}
if(data.warning){var message_parts=data.warning.split('<><>');showMessage(message_parts[1],getTranslatedString(message_parts[0]),'');}
if(is_post_add)
{if($form.attr('action').indexOf(confirm_attr)>0)
$form.attr('action',$form.attr('action').replace(new RegExp('.'+confirm_attr),''));if($form.find('.confirm-html').length)
$form.find('.confirm-html').html('');}
$context.checkSocialRepost(data.insert_id,data.link);var is_answer_skip=$form.parents('.top-comment').find('.answers-skip').length;$context.clear();$context.setInitText('');$context.hideReplyForm();if(settings.is_answer){update_comments(wrapdiv,data,true,false,settings.is_mix_mode,is_answer_skip);}
else
{if(!is_post_add)
{if($.cookie('c_sort')==2)
{if(c_selector.find('.idcomments-main .comment').length<50)
update_comments(wrapdiv,data,false);}
else update_comments(wrapdiv,data,true);}
else update_post_comments(data,false,false,is_post_add);}
h=parseInt($('.comment-textarea').css('line-height'));$('.comment-textarea').css('height',3*h);}
updateCommentForms();$('.notify_add .notify_add-text').html('');$('.notify_add .notify_add-users').html('');},error:function(data,status,xhr,$form){$form.find('.reply-wrap').removeClass('progress_comment_form');$form.find('.progress_comment_img').hide();}});if(!settings.mobile)
{$self.on('click','.icon-input-demotivation-add',function(){$context.hideBlocks();$context.showGeneratorForm('demotivation');return false;});$self.on('click','.icon-input-mem-add',function(){$context.hideBlocks();$context.showGeneratorForm('mem');return false;});$self.on('click','.icon-input-photo-add',function(){$context.hideBlocks();$context.find('.photo-add').show();return false;});$self.on('click','.icon-input-video-add',function(){$context.hideBlocks();$context.find('.video-add').show();elem=$context.children().find('.video-add-ok');fitVideoTextarea(elem);return false;});$self.on('click','.icon-input-twit-add',function(){$context.hideBlocks();$context.find('.embed-add.embed-twitter').show();return false;});$self.on('click','.icon-input-inst-add',function(){$context.hideBlocks();$context.find('.embed-add.embed-instagram').show();return false;});$self.on('click','.icon-input-url-add',function(){$context.hideBlocks();$context.find('.embed-add.embed-url').show();return false;});$self.on('click','.icon-input-elem',function(){var t=$context.find('textarea');if(t&&t.length){var e=$(this).attr('data-elem');var r=t.range();var text="["+e+"]"+r.text+"[/"+e+"]";t.range(text);}
return false;});function _saveNewUrl($input){url=$.trim($input.val());if((url=='http://')||(url=='')){return false;}
url=encodeURIComponent(url);$context.hideBlocks();$.ajax({type:'post',url:'/comment/uploadUrl',data:'url='+url,dataType:'json',success:function(response){if(response.success==true&&response.url){var form=$($input).closest('.comments-form-wrapper');var text=form.find('.comment-textarea');var cursorPos=text.prop('selectionStart');var v=text.val();var textBefore=v.substring(0,cursorPos);var textAfter=v.substring(cursorPos,v.length);var html="<a href='"+url+"' target='_blank'>"+url+"</a>";text.val(textBefore+html+textAfter);}else if(response.error){showMessage(response.error,'','error');}
$context.find('.photo-add .url, input.embed-add, input.video-add, textarea.video-add').removeClass('process');}});}
function _saveUrlInInput($input,check_process)
{if(check_process&&$input.hasClass('process')){return;}
if($.trim($input.val())==''){return false;}
if($input.hasClass('embed-url')){_saveNewUrl($input);}else{_saveUrl($input.val());}
$input.val('');$input.addClass('process');}
$(this).find('.photo-add .save.ok, .embed-add .save.ok').click(function(event){event.preventDefault();_saveUrlInInput($(this).siblings('input:text'),true);});$(this).find('.video-add .save.ok').click(function(event){event.preventDefault();_saveUrlInInput($(this).siblings('textarea'),true);_saveUrlInInput($(this).siblings('input:text'),true);});}
function _saveUrl(url,paramsDownload){var res=$context.linkDownload(url,paramsDownload);$context.hideBlocks();if(!res)
{$block=$context.find('.attaches');if($('.image-preview:not(.type_attach_embed)',$block).length>0)
{$('<div class="reply-attached loading"></div>').insertAfter($('.image-preview:not(.type_attach_embed)',$block).last());}
else
{$block.prepend($('<div class="reply-attached loading"></div>'));}}}
$self.on('click','.input-gif-add',function(){$context.hideBlocks();$context.find('.gif-add').show();return false;});var $gifInput=$(this).find('.gif-add input');var $gifLoader=$(this).find('.gif-add__loader');var $gifResults=$(this).find('.gif-add__results');var tenorSearch=fishki.utils.debounce(function(cb){fishki.tenorjs.search($gifInput.val(),function(resp){cb(resp);});},500);$gifInput.keyup(function(event){if(!fishki||!fishki.tenorjs)
throw new Error("fishki.tenorjs is not defined");var val=$gifInput.val();if(val&&val!=$gifInput.data('old-val'))
{$gifResults.hide();$gifLoader.show();$gifInput.data('old-val',val);tenorSearch(function(resp){var html='';for(var i in resp)
{console.log('Media: ',resp[i]['media'][0]);var mediaNano=resp[i]['media'][0]['nanogif'];var media=resp[i]['media'][0]['gif'];var mediaHtml='<div class="gif-add__media" data-media="'+media.url+'"><img src="'+mediaNano.url+'" width="'+mediaNano.dims[0]+'" height="'+mediaNano.dims[1]+'" /></div>';html+=mediaHtml;}
$gifLoader.hide();$gifResults.html(html).show();});}});$(document).on('click','.gif-add__media',function(){$gifResults.hide();$gifLoader.hide();$gifInput.val('');var url=$(this).data('media');_saveUrl(url,{endpointDownloadOriginal:true,previewClassName:'gif-original'});});$self.find('textarea').filter('.comment-photo textarea').focus(function(){$self.find('.comments-form-button').filter('.comment-photo .comments-form-button').slideDown();});$(this).inited=true;}
if(!$context.inited)
$context.init();});}